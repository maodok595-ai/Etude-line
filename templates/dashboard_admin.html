<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Étude LINE</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Étude LINE">
    <link rel="manifest" href="/static/manifest.json">
    <!-- Apple Touch Icon for iOS (180x180 is the standard for modern iPhones) -->
    <link rel="apple-touch-icon" href="/static/icons/icon-180.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a1a;
            --secondary: #f8fafc;
            --accent: #6366f1;
            --success: #10b981;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            font-weight: 400;
            line-height: 1.6;
            color: var(--text-primary);
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .navbar::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }
        
        .navbar h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }
        
        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .navbar a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            border: 1px solid transparent;
        }
        
        .navbar a:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .container {
            max-width: min(1200px, 100%);
            margin: 0.5rem auto 2rem;
            padding: 0 2rem;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* Desktop Pro Optimizations - Full Width Experience */
        @media (min-width: 1400px) {
            .container {
                max-width: 95%;
                padding: 0 3rem;
            }
            
            .welcome-card {
                padding: 2rem 2.5rem;
            }
            
            .university-logo {
                width: 130px;
                height: 130px;
            }
            
            .university-name {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                gap: 2rem;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            
            .stat-card {
                padding: 2rem;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            }
            
            .main-content {
                gap: 2rem;
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            }
            
            .card {
                padding: 2rem;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.12);
            }
        }
        
        @media (min-width: 1600px) {
            .container {
                max-width: 96%;
                padding: 0 4rem;
            }
            
            .navbar {
                padding: 1.5rem 4rem;
            }
            
            .navbar h1 {
                font-size: 2rem;
            }
            
            .welcome-card {
                padding: 2.5rem 3rem;
            }
            
            .university-logo {
                width: 150px;
                height: 150px;
            }
            
            .stats-grid {
                gap: 2.5rem;
                grid-template-columns: repeat(6, 1fr);
            }
            
            .main-content {
                gap: 2.5rem;
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            }
        }
        
        @media (min-width: 1920px) {
            .container {
                max-width: 97%;
                padding: 0 5rem;
            }
            
            .navbar {
                padding: 2rem 5rem;
            }
            
            .navbar h1 {
                font-size: 2.2rem;
            }
            
            .welcome-card {
                padding: 3rem 3.5rem;
            }
            
            .stats-grid {
                gap: 3rem;
            }
            
            .main-content {
                gap: 3rem;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .card {
                padding: 2.5rem;
            }
        }
        
        @media (min-width: 2560px) {
            .container {
                max-width: 98%;
                padding: 0 6rem;
            }
            
            .navbar {
                padding: 2.5rem 6rem;
            }
            
            .navbar h1 {
                font-size: 2.5rem;
            }
            
            .stats-grid {
                gap: 3.5rem;
            }
            
            .main-content {
                gap: 3.5rem;
                grid-template-columns: repeat(4, 1fr);
            }
            
            .card {
                padding: 3rem;
                font-size: 1.1rem;
            }
            
            .welcome-card h2 {
                font-size: 2.5rem;
            }
        }

        /* Tablet adjustments (light touch) */
        @media screen and (max-width: 768px) {
            .container {
                padding: 0 1rem !important;
            }
            
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .main-content {
                grid-template-columns: 1fr !important;
                gap: 1.5rem !important;
            }
            
            /* Onglets scrollables sur tablette */
            .tabs-container {
                overflow-x: auto !important;
                overflow-y: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: thin !important;
                flex-wrap: nowrap !important;
                padding-bottom: 0.5rem !important;
            }
            
            .tabs-container::-webkit-scrollbar {
                height: 4px !important;
            }
            
            .tabs-container::-webkit-scrollbar-thumb {
                background: var(--accent) !important;
                border-radius: 2px !important;
            }
            
            .tab-btn {
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }
        }
        
        /* Mobile Responsive - Version Pro */
        @media screen and (max-width: 600px) {
            .navbar {
                padding: 1rem !important;
                flex-direction: column !important;
                gap: 0.75rem !important;
                text-align: center !important;
            }
            
            .navbar h1 {
                font-size: 1.3rem !important;
                line-height: 1.2 !important;
            }
            
            .navbar .user-info {
                flex-direction: column !important;
                gap: 0.5rem !important;
                font-size: 0.9rem !important;
            }
            
            .container {
                margin: 1rem auto !important;
                padding: 0 0.75rem !important;
            }
            
            .welcome-card {
                padding: 1.25rem !important;
                margin-bottom: 1.25rem !important;
            }
            
            .university-logo {
                width: 80px !important;
                height: 80px !important;
            }
            
            .university-name {
                font-size: 1rem !important;
                line-height: 1.3 !important;
            }
            
            .user-info-box {
                padding: 0.75rem !important;
                font-size: 0.85rem !important;
            }
            
            .card {
                padding: 1.25rem !important;
            }
            
            .card h2 {
                font-size: 1.1rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .form-group {
                margin-bottom: 0.75rem !important;
            }
            
            .form-group label {
                font-size: 0.85rem !important;
                margin-bottom: 0.35rem !important;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.75rem !important;
                font-size: 16px !important; /* Évite le zoom sur iOS */
            }
            
            .btn {
                padding: 0.7rem 1rem !important;
                font-size: 0.9rem !important;
                width: 100% !important;
                margin-top: 0.5rem !important;
            }
            
            table {
                font-size: 0.85rem !important;
            }
            
            th, td {
                padding: 0.5rem !important;
            }
            
            .tab-btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.85rem !important;
            }
            
            /* Liste des professeurs responsive */
            .prof-item {
                padding: 1rem !important;
            }
            
            .prof-meta {
                gap: 0.4rem !important;
            }
            
            .meta-tag {
                font-size: 0.75rem !important;
                padding: 0.2rem 0.4rem !important;
            }
            
            /* Statistiques - Grille 2x3 sur tablette */
            .stats-horizontal-container {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
                padding: 0.3rem 0 !important;
                overflow-x: visible !important;
            }
            
            .stat-vertical-card {
                min-width: auto !important;
                max-width: none !important;
            }
            
            .stat-vertical-card h3 {
                font-size: 0.85rem !important;
            }
            
            .stat-number-large {
                font-size: 2.5rem !important;
            }
        }

        @media screen and (max-width: 480px) {
            .navbar {
                padding: 0.75rem !important;
            }
            
            .navbar h1 {
                font-size: 1.1rem !important;
            }
            
            .container {
                margin: 0.5rem auto !important;
                padding: 0 0.5rem !important;
            }
            
            .welcome-card {
                padding: 1rem !important;
            }
            
            .university-logo {
                width: 70px !important;
                height: 70px !important;
            }
            
            .university-name {
                font-size: 0.95rem !important;
            }
            
            .card {
                padding: 1rem !important;
            }
            
            .card h2 {
                font-size: 1rem !important;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.65rem !important;
            }
            
            .btn {
                padding: 0.6rem 0.85rem !important;
                font-size: 0.85rem !important;
            }
            
            .stats-toggle-btn {
                font-size: 0.9rem !important;
                padding: 0.6rem 1rem !important;
            }
            
            .tab-btn {
                padding: 0.6rem 0.8rem !important;
                font-size: 0.75rem !important;
            }
            
            .stat-value {
                font-size: 1.5rem !important;
            }
            
            /* Stats grille 2x3 pour petits écrans */
            .stats-horizontal-container {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
                overflow-x: visible !important;
            }
            
            .stat-vertical-card {
                min-width: auto !important;
                max-width: none !important;
                padding: 0.75rem !important;
            }
            
            .stat-vertical-card h3 {
                font-size: 0.8rem !important;
            }
            
            .stat-number-large {
                font-size: 2rem !important;
            }
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            position: relative;
            overflow: hidden;
        }
        
        .welcome-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6, var(--accent));
        }
        
        .welcome-card h2 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 1.3rem;
            letter-spacing: -0.01em;
        }
        
        .welcome-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            margin: 0.3rem 0;
        }
        
        /* Styles pour le logo et nom de l'université (admin secondaire) - Coloration violette */
        .university-welcome {
            text-align: center;
            background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%);
            padding: 1.5rem 1rem 1rem;
            margin: 0;
            border-radius: 0;
            position: relative;
            border-bottom: 3px solid #9C27B0;
        }
        
        .university-welcome::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #9C27B0, #7B1FA2, #9C27B0);
        }

        .university-logo {
            width: 90px;
            height: 90px;
            object-fit: contain;
            display: block;
            border-radius: 12px;
            background: white;
            padding: 0.6rem;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }

        .university-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 0.75rem 0;
            line-height: 1.4;
        }

        .user-info-box {
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.15) 0%, rgba(123, 31, 162, 0.12) 50%, rgba(156, 39, 176, 0.15) 100%);
            border-radius: 12px;
            margin-top: 1rem;
            border: 2px solid #9C27B0;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .user-info-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #9C27B0, #7B1FA2, #9C27B0);
        }

        .user-info-box p {
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.95rem;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .user-info-box p strong {
            color: #9C27B0;
            font-weight: 600;
        }

        .user-info-box p:last-child {
            margin-bottom: 0;
        }
        
        /* Statistiques - Affichage Desktop Full Width */
        .stats-horizontal-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 0.5rem 0;
        }
        
        .stat-vertical-card {
            padding: 1rem !important;
        }
        
        /* Optimisations Desktop pour les statistiques */
        @media (min-width: 1400px) {
            .stats-horizontal-container {
                gap: 1.5rem;
            }
            
            .stat-vertical-card {
                padding: 1.5rem !important;
            }
        }
        
        @media (min-width: 1600px) {
            .stats-horizontal-container {
                gap: 2rem;
            }
            
            .stat-vertical-card {
                padding: 1.75rem !important;
            }
        }
        
        @media (min-width: 1920px) {
            .stats-horizontal-container {
                gap: 2.5rem;
            }
            
            .stat-vertical-card {
                padding: 2rem !important;
            }
        }
        
        .stat-number-large {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent);
            text-align: center;
            font-family: 'Georgia', 'Times New Roman', serif;
            letter-spacing: -0.02em;
            line-height: 1.2;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stats-toggle-btn {
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        
        .stats-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .stats-toggle-btn:active {
            transform: translateY(0);
        }
        
        #stats-arrow {
            transition: transform 0.3s ease;
            font-weight: bold;
        }
        
        #stats-container {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }
        
        .card h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.875rem;
            letter-spacing: 0.01em;
        }
        
        .password-field {
            position: relative;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .password-field input {
            padding-right: 3rem;
        }
        
        .toggle-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            padding: 0.25rem;
            border-radius: 4px;
        }
        
        .toggle-password:hover {
            color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.01em;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .prof-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .prof-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .prof-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .prof-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .prof-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        .prof-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .meta-tag {
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        /* Styles pour les onglets */
        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #666;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Styles pour les formulaires cachés */
        .hidden {
            display: none !important;
            opacity: 0;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
        
        /* Bouton de création principal */
        .create-btn {
            width: 100%;
            padding: 0.8rem 1.2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            margin-bottom: 1.2rem;
            position: relative;
            overflow: hidden;
        }
        
        .create-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .create-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }
        
        .create-btn:hover::before {
            left: 100%;
        }
        
        .create-btn:active {
            transform: translateY(-1px);
        }
        
        /* Bouton d'annulation dans les formulaires */
        .cancel-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            line-height: 1;
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
        }
        
        .cancel-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            transform: rotate(90deg);
        }
        
        /* En-tête du formulaire avec bouton annuler */
        .form-header {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .form-header h3 {
            margin-right: 3rem;
        }
        
        .academic-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }
        
        .academic-item h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .academic-code {
            color: #666;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }
        
        .btn-edit {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .btn-edit:hover {
            background: #218838;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-small {
            padding: 0.3rem 0.8rem;
            font-size: 0.75rem;
        }
        
        /* Logo Étude LINE pour admin principal */
        .main-admin-logo {
            text-align: center;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            padding: 1rem 1rem 0.75rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            border-radius: var(--radius) var(--radius) 0 0;
            position: relative;
        }
        
        .main-admin-logo::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }
        
        .main-admin-logo img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.3));
            animation: fadeInScale 0.6s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @media screen and (max-width: 768px) {
            .main-admin-logo img {
                width: 90px;
                height: 90px;
            }
        }
        
        /* Style pour la page complète de l'administrateur secondaire */
        body.admin-secondaire {
            background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 50%, #f3e8ff 100%) !important;
        }
        
        body.admin-secondaire .container {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body{% if not admin.get('is_main_admin') %} class="admin-secondaire"{% endif %}>
    <nav class="navbar">
        <h1>🎓 Étude LINE - Administration</h1>
        <div class="user-info">
            <a href="/logout" style="color: #8b5cf6; font-weight: 600;">Déconnexion</a>
        </div>
    </nav>
    
    <div class="container">
        <!-- Messages d'alerte -->
        <div id="alert-container"></div>
        
        <script>
            // Fonction pour afficher un message qui disparaît automatiquement
            function showAlert(message, type = 'success') {
                const container = document.getElementById('alert-container');
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = (type === 'success' ? '✅ ' : '⚠️ ') + message;
                
                container.appendChild(alertDiv);
                
                // Faire disparaître après 4 secondes
                setTimeout(() => {
                    alertDiv.style.transition = 'opacity 0.5s, transform 0.5s';
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transform = 'translateY(-20px)';
                    setTimeout(() => alertDiv.remove(), 500);
                }, 4000);
            }
            
            // Afficher les messages depuis l'URL au chargement
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                showAlert(urlParams.get('success'), 'success');
                // Nettoyer l'URL sans recharger la page
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            if (urlParams.has('error')) {
                showAlert(urlParams.get('error'), 'error');
                // Nettoyer l'URL sans recharger la page
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Fonction pour afficher/masquer les sections de liste
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const arrow = document.getElementById('arrow-' + sectionId);
                
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    arrow.textContent = '▼';
                } else {
                    section.style.display = 'none';
                    arrow.textContent = '►';
                }
            }
            
            // Fonction pour afficher/masquer les détails d'un utilisateur (prof/étudiant)
            // Note: L'état des flèches n'est PAS sauvegardé - tout reste fermé à chaque rechargement
            function toggleUserDetails(userId) {
                const details = document.getElementById('details-' + userId);
                const arrow = document.getElementById('arrow-' + userId);
                const actions = document.getElementById('actions-' + userId);
                
                if (details && arrow) {
                    if (details.style.display === 'none') {
                        details.style.display = 'block';
                        arrow.textContent = '▼';
                        if (actions) actions.style.display = 'block';
                    } else {
                        details.style.display = 'none';
                        arrow.textContent = '►';
                        if (actions) actions.style.display = 'none';
                    }
                }
            }
            
            // Fonction pour afficher/masquer le contenu d'une filière dans la liste des étudiants
            function toggleFiliereEtudiants(filiereId) {
                const content = document.getElementById('content-' + filiereId);
                const arrow = document.getElementById('arrow-' + filiereId);
                
                if (content && arrow) {
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        arrow.textContent = '▼';
                    } else {
                        content.style.display = 'none';
                        arrow.textContent = '►';
                    }
                }
            }
            
            // Fonction pour afficher/masquer le contenu d'un niveau dans la liste des étudiants
            function toggleNiveauEtudiants(niveauId) {
                const content = document.getElementById('content-' + niveauId);
                const arrow = document.getElementById('arrow-' + niveauId);
                
                if (content && arrow) {
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        arrow.textContent = '▼';
                    } else {
                        content.style.display = 'none';
                        arrow.textContent = '►';
                    }
                }
            }
            
            function toggleStatCard(statId) {
                const content = document.getElementById('content-' + statId);
                const arrow = document.getElementById('arrow-' + statId);
                
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    arrow.textContent = '▼';
                    arrow.style.transform = 'rotate(90deg)';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '►';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
            
            // Exposer les fonctions au scope global pour les attributs onclick
            // Ceci résout le problème où les fonctions ne sont pas accessibles sur Render
            window.showAlert = showAlert;
            window.toggleSection = toggleSection;
            window.toggleUserDetails = toggleUserDetails;
            window.toggleFiliereEtudiants = toggleFiliereEtudiants;
            window.toggleNiveauEtudiants = toggleNiveauEtudiants;
            window.toggleStatCard = toggleStatCard;
        </script>
        
        <!-- Pré-déclaration des fonctions définies plus bas pour les onglets -->
        <script>
            // Fonction temporaire pour éviter les erreurs avant le chargement complet
            function showTab(tabName) {
                // Cette fonction sera remplacée par la vraie version plus bas
                const contents = document.querySelectorAll('.tab-content');
                contents.forEach(content => content.classList.remove('active'));
                const tabs = document.querySelectorAll('.tab-btn');
                tabs.forEach(tab => tab.classList.remove('active'));
                document.getElementById('content-' + tabName).classList.add('active');
                document.getElementById('tab-' + tabName).classList.add('active');
            }
            window.showTab = showTab;
        </script>
        
        {% if error %}
        <script>showAlert('{{ error }}', 'error');</script>
        {% endif %}
        
        <div class="welcome-card">
            {% if admin.get('is_main_admin') %}
                <!-- Admin Principal : Logo + Affichage standard -->
                <div class="main-admin-logo">
                    <img src="/static/logo-etude-line.png" alt="Logo Étude LINE">
                </div>
                <h2>Bienvenue, {{ admin.prenom|upper }} {{ admin.nom|upper }}</h2>
                <p><strong>Rôle:</strong> Administrateur Principal</p>
            {% else %}
                <!-- Admin Secondaire : Logo + Nom université -->
                <div class="university-welcome">
                    <h2 class="university-name">
                        BIENVENUE A L'{{ admin_universite.nom if admin_universite else "UNIVERSITÉ INCONNUE" }}
                    </h2>
                    {% if admin_universite and admin_universite.logo_url %}
                        <div style="display: inline-block; padding: 10px; background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(123, 31, 162, 0.2)); border-radius: 18px; box-shadow: 0 8px 24px rgba(156, 39, 176, 0.5), 0 0 0 4px rgba(255, 255, 255, 0.1); margin: 0.5rem auto 0;">
                            <img src="{{ admin_universite.logo_url }}" alt="Logo {{ admin_universite.nom }}" class="university-logo">
                        </div>
                    {% endif %}
                    <div class="user-info-box">
                        <p><strong>Prénom et nom :</strong> {{ admin.prenom|upper }} {{ admin.nom|upper }}</p>
                        <p><strong>Rôle :</strong> Administrateur de l'{{ admin_universite.nom if admin_universite else "Université inconnue" }}</p>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- Contrôles des fonctionnalités -->
        <div style="margin: 1.5rem 0;">
            <h3 style="margin-bottom: 0.75rem; color: #333; font-size: 1.1rem; font-weight: 600;">
                ⚙️ Contrôles des fonctionnalités
                {% if not admin.get('is_main_admin') and admin_universite %}
                    <span style="color: #9C27B0; font-weight: 500;">({{ admin_universite.nom }})</span>
                {% endif %}
            </h3>
            
            {% if admin.get('is_main_admin') %}
            <!-- Sélecteur d'université pour l'admin principal -->
            <div style="margin-bottom: 1rem;">
                <label for="universite-selector" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #555;">
                    🏛️ Sélectionnez une université à gérer:
                </label>
                <select id="universite-selector" onchange="loadUniversiteSettings()" 
                        style="width: 100%; max-width: 400px; padding: 0.75rem; border: 2px solid #8b5cf6; border-radius: 8px; font-size: 1rem; background: white; cursor: pointer;">
                    <option value="">-- Choisir une université --</option>
                    {% for univ in universites %}
                    <option value="{{ univ.id }}">{{ univ.nom }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div id="controls-container" style="display: {% if admin.get('is_main_admin') %}none{% else %}flex{% endif %}; gap: 1rem; flex-wrap: wrap;">
                <!-- Bouton contrôle téléchargements -->
                <button onclick="toggleTelechargements()" id="download-toggle-btn" class="stats-toggle-btn" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
                    <span id="download-icon">📥</span> Téléchargements
                    <span id="download-status">: Chargement...</span>
                </button>
                
                <!-- Bouton contrôle passage en classe supérieure -->
                <button onclick="togglePassageClasse()" id="passage-toggle-btn" class="stats-toggle-btn" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
                    <span id="passage-icon">🎓</span> Passage classe sup.
                    <span id="passage-status">: Chargement...</span>
                </button>
            </div>
        </div>
        
        <!-- Statistiques du système (toujours visibles) -->
        <h3 style="margin: 1.5rem 0 1rem 0; color: #9C27B0; font-size: 1.2rem;">📊 Statistiques universitaires</h3>
        <div class="stats-horizontal-container" id="stats-container">
            <!-- Ligne 1 : Professeurs | Étudiants -->
            <div class="card stat-vertical-card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0; font-size: 0.9rem;" onclick="toggleStatCard('stat-1')">
                    <span>👨‍🏫 Professeurs</span>
                    <span id="arrow-stat-1" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="content-stat-1" style="display: none; padding-top: 1rem;">
                    <div class="stat-number-large">{{ stats.users.professeurs }}</div>
                </div>
            </div>
            
            <div class="card stat-vertical-card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0; font-size: 0.9rem;" onclick="toggleStatCard('stat-2')">
                    <span>👨‍🎓 Étudiants</span>
                    <span id="arrow-stat-2" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="content-stat-2" style="display: none; padding-top: 1rem;">
                    <div class="stat-number-large">{{ stats.users.etudiants }}</div>
                </div>
            </div>
            
            <!-- Ligne 2 : Universités | Cours -->
            <div class="card stat-vertical-card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0; font-size: 0.9rem;" onclick="toggleStatCard('stat-3')">
                    <span>🏛️ Universités</span>
                    <span id="arrow-stat-3" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="content-stat-3" style="display: none; padding-top: 1rem;">
                    <div class="stat-number-large">{{ stats.structure_academique.universites }}</div>
                </div>
            </div>
            
            <div class="card stat-vertical-card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0; font-size: 0.9rem;" onclick="toggleStatCard('stat-4')">
                    <span>📚 Cours</span>
                    <span id="arrow-stat-4" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="content-stat-4" style="display: none; padding-top: 1rem;">
                    <div class="stat-number-large">{{ stats.chapitres.cours }}</div>
                </div>
            </div>
            
            <!-- Ligne 3 : Exercices | Solutions -->
            <div class="card stat-vertical-card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0; font-size: 0.9rem;" onclick="toggleStatCard('stat-5')">
                    <span>📝 Exercices</span>
                    <span id="arrow-stat-5" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="content-stat-5" style="display: none; padding-top: 1rem;">
                    <div class="stat-number-large">{{ stats.chapitres.exercice }}</div>
                </div>
            </div>
            
            <div class="card stat-vertical-card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0; font-size: 0.9rem;" onclick="toggleStatCard('stat-6')">
                    <span>✅ Solutions</span>
                    <span id="arrow-stat-6" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="content-stat-6" style="display: none; padding-top: 1rem;">
                    <div class="stat-number-large">{{ stats.chapitres.solution }}</div>
                </div>
            </div>
        </div>
        
        <!-- Navigation par onglets -->
        <div style="margin-bottom: 2rem;">
            <div class="tabs-container" style="display: flex; gap: 1rem; border-bottom: 2px solid #e9ecef; overflow-x: auto;">
                <button onclick="showTab('admin')" id="tab-admin" class="tab-btn active">👑 Administrateurs</button>
                <button onclick="showTab('prof')" id="tab-prof" class="tab-btn">👨‍🏫 Professeurs</button>
                <button onclick="showTab('etudiant')" id="tab-etudiant" class="tab-btn">👨‍🎓 Étudiants</button>
                <button onclick="showTab('universite')" id="tab-universite" class="tab-btn">🏛️ Universités</button>
                <button onclick="showTab('ufr')" id="tab-ufr" class="tab-btn">🏢 UFR</button>
                <button onclick="showTab('filiere')" id="tab-filiere" class="tab-btn">📚 Filières</button>
                <button onclick="showTab('matiere')" id="tab-matiere" class="tab-btn">📖 Matières</button>
                <button onclick="showTab('passage')" id="tab-passage" class="tab-btn">🎓 Hiérarchie de passage</button>
            </div>
        </div>

        <!-- Contenu des onglets -->
        
        <!-- Onglet Administrateurs -->
        <div id="content-admin" class="tab-content active">
            <!-- Formulaire de création -->
            {% if admin.is_main_admin %}
            <div id="admin-form-view">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0 0 1rem;" onclick="toggleSection('admin-creation')">
                    <span>👑 Créer un administrateur</span>
                    <span id="arrow-admin-creation" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="admin-creation" style="display: none;">
                    <div class="card" style="position: relative;">
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; color: #856404;">
                            <strong>⚠️ Privilège d'administrateur principal</strong><br>
                            Vous seul pouvez ajouter de nouveaux administrateurs.
                        </div>
                        <form action="/admin/create-admin" method="post">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="admin-nom">Nom</label>
                                <input type="text" id="admin-nom" name="nom" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-prenom">Prénom</label>
                                <input type="text" id="admin-prenom" name="prenom" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="admin-username">Nom d'utilisateur</label>
                            <input type="text" id="admin-username" name="username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="admin-universite">Université gérée</label>
                            <input type="search" id="search-admin-universite" 
                                   placeholder="🔍 Rechercher une université..." 
                                   oninput="filterSelectOptions('search-admin-universite', 'admin-universite')"
                                   style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                            <select id="admin-universite" name="universite_id" required>
                                <option value="">Sélectionner une université</option>
                                {% for uni in universites %}
                                <option value="{{ uni.id }}">{{ uni.nom }}</option>
                                {% endfor %}
                            </select>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                Cet administrateur pourra uniquement gérer les entités de cette université.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="admin-password">Mot de passe</label>
                            <div class="password-field">
                                <input type="password" id="admin-password" name="password" autocomplete="new-password" required>
                                <button type="button" class="toggle-password" onclick="togglePassword('admin-password')">
                                    👁️
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn">Créer l'administrateur</button>
                    </form>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Vue liste -->
            <div id="admin-list-view">
                
                <!-- Liste des administrateurs -->
                <div class="card">
                    <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;" onclick="toggleSection('admin-list')">
                        <span>👑 Administrateurs ({{ admins|length }})</span>
                        <span id="arrow-admin-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                    </h3>
                    <div id="admin-list" style="display: none;">
                    <input type="search" id="search-admin" class="search-input" 
                           placeholder="🔍 Rechercher un administrateur..." 
                           onkeyup="searchAdmin()">
                    <div id="admin-count" class="search-result-count"></div>
                    <div class="prof-list" id="admin-items">
                        {% if admins %}
                            {% for administrator in admins %}
                            <div class="prof-item academic-item" style="{% if administrator.get('is_main_admin') %}border-left: 4px solid #f39c12; background: linear-gradient(135deg, #fff7e6, #ffeaa7);{% elif administrator.username == admin.username %}border-left: 4px solid #667eea;{% endif %}">
                                <div class="prof-name">
                                    {{ administrator.prenom }} {{ administrator.nom }}
                                    {% if administrator.get('is_main_admin') %}
                                        <span style="background: #f39c12; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.5rem;">PRINCIPAL</span>
                                    {% elif administrator.username == admin.username %}
                                        <span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.5rem;">VOUS</span>
                                    {% endif %}
                                </div>
                                <div class="prof-details">
                                    <strong>Nom d'utilisateur:</strong> {{ administrator.username }}
                                </div>
                                {% if not administrator.get('is_main_admin') and administrator.get('universite_id') %}
                                <div class="prof-details">
                                    <strong>Université:</strong> 
                                    {% for univ in universites %}
                                        {% if univ.id == administrator.universite_id %}
                                            {{ univ.nom }}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="prof-meta">
                                    <span class="meta-tag">👑 Administrateur</span>
                                    {% if administrator.get('is_main_admin') %}
                                        <span class="meta-tag" style="background: #f39c12; color: white;">Administrateur Principal</span>
                                    {% endif %}
                                </div>
                                {% if not administrator.get('is_main_admin') and admin.get('is_main_admin') %}
                                <div class="action-buttons">
                                    <button class="btn-edit btn-small" onclick='editAdmin({{ administrator.username|tojson }}, {{ administrator.prenom|tojson }}, {{ administrator.nom|tojson }})' title="Modifier">
                                        ✏️
                                    </button>
                                    <button class="btn-delete btn-small" onclick='deleteAdmin({{ administrator.username|tojson }}, {{ (administrator.prenom ~ " " ~ administrator.nom)|tojson }})' title="Supprimer">
                                        🗑️
                                    </button>
                                    <button class="btn-small" 
                                            data-username="{{ administrator.username }}"
                                            data-fullname="{{ administrator.prenom }} {{ administrator.nom }}"
                                            onclick='toggleAdminStatus({{ administrator.username|tojson }}, {{ (administrator.prenom ~ " " ~ administrator.nom)|tojson }}, {{ administrator.get("actif")|tojson|lower }})' 
                                            style="background: {{ '#28a745' if administrator.get('actif') else '#dc3545' }}; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;"
                                            title="{{ 'Désactiver' if administrator.get('actif') else 'Activer' }}">
                                        {{ 'ON' if administrator.get('actif') else 'OFF' }}
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>👑 Aucun autre administrateur</p>
                                <p>Vous êtes actuellement le seul administrateur du système.</p>
                            </div>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-prof" class="tab-content">
            <!-- Vue liste -->
            <div id="prof-list-view">
                <button onclick="toggleForm('prof')" class="create-btn">
                    ➕ Créer un professeur
                </button>
                
                <!-- Liste des professeurs -->
                <div class="card">
                    <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;" onclick="toggleSection('prof-list')">
                        <span>📚 Professeurs ({{ profs|length }})</span>
                        <span id="arrow-prof-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                    </h3>
                    <div id="prof-list" style="display: none;">
                    <input type="search" id="search-prof" class="search-input" 
                           placeholder="🔍 Rechercher un professeur..." 
                           onkeyup="searchProf()">
                    <div id="prof-count" class="search-result-count"></div>
                    <div class="prof-list" id="prof-items">
                        {% if profs %}
                            {% for prof in profs %}
                            <div class="prof-item academic-item">
                                <div class="prof-name" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;" onclick="toggleUserDetails('prof-{{ loop.index }}')">
                                    <span id="arrow-prof-{{ loop.index }}" style="font-size: 0.9rem; transition: transform 0.3s;">►</span>
                                    <span>{{ prof.prenom }} {{ prof.nom }}</span>
                                </div>
                                <div id="details-prof-{{ loop.index }}" style="display: none;">
                                <div class="prof-details">@{{ prof.username }}</div>
                                <div class="prof-meta">
                                    <span class="meta-tag" style="background: #e3f2fd; color: #1976d2;">🎓 {{ prof.specialite }}</span>
                                    
                                    {% if prof.ufrs %}
                                        {% for ufr in prof.ufrs %}
                                            <span class="meta-tag" style="background: #fff3e0; color: #f57c00;">📚 {{ ufr.nom }}</span>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if prof.filieres %}
                                        {% for filiere in prof.filieres %}
                                            <span class="meta-tag" style="background: #f3e5f5; color: #7b1fa2;">📖 {{ filiere.nom }}</span>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% for uni in universites %}
                                        {% if uni.id == prof.universite_id %}
                                            <span class="meta-tag" style="background: #e8f5e9; color: #388e3c;">🏛️ {{ uni.nom }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn-edit btn-small" onclick='editProf({{ prof.username|tojson }}, {{ prof.nom|tojson }}, {{ prof.prenom|tojson }}, {{ prof.specialite|tojson }})' title="Modifier">
                                        ✏️
                                    </button>
                                    <button class="btn-delete btn-small" onclick='deleteProf({{ prof.username|tojson }}, {{ (prof.prenom ~ " " ~ prof.nom)|tojson }})' title="Supprimer">
                                        🗑️
                                    </button>
                                    {% if admin.is_main_admin %}
                                    <button class="btn-small" 
                                            data-username="{{ prof.username }}"
                                            data-fullname="{{ prof.prenom }} {{ prof.nom }}"
                                            onclick='toggleProfStatus({{ prof.username|tojson }}, {{ (prof.prenom ~ " " ~ prof.nom)|tojson }}, {{ prof.get("actif")|tojson|lower }})' 
                                            style="background: {{ '#28a745' if prof.get('actif') else '#dc3545' }}; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;"
                                            title="{{ 'Désactiver' if prof.get('actif') else 'Activer' }}">
                                        {{ 'ON' if prof.get('actif') else 'OFF' }}
                                    </button>
                                    {% endif %}
                                </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>👨‍🏫 Aucun professeur créé</p>
                                <p>Cliquez sur le bouton ci-dessus pour créer le premier professeur.</p>
                            </div>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulaire de création (caché par défaut) -->
            <div id="prof-form-view" class="hidden">
                <div class="card" style="position: relative;">
                    <button type="button" onclick="toggleForm('prof')" class="cancel-btn" title="Annuler">✕</button>
                    <div class="form-header">
                        <h3>👨‍🏫 Créer un professeur</h3>
                    </div>
                    <form action="/admin/create-prof" method="post">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Nom</label>
                            <input type="text" id="nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="prenom">Prénom</label>
                            <input type="text" id="prenom" name="prenom" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="username">Nom d'utilisateur</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Mot de passe</label>
                        <div class="password-field">
                            <input type="password" id="password" name="password" autocomplete="new-password" required>
                            <button type="button" class="toggle-password" onclick="togglePassword('password')">
                                👁️
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="prof-universite">Université</label>
                            <input type="search" id="search-prof-universite" 
                                   placeholder="🔍 Rechercher une université..." 
                                   oninput="filterSelectOptions('search-prof-universite', 'prof-universite')"
                                   style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                            <select id="prof-universite" name="universite_id" required>
                                <option value="">Sélectionner une université</option>
                                {% for uni in universites %}
                                <option value="{{ uni.id }}">{{ uni.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>UFR (au moins une requise) <span style="color: #e74c3c;">*</span></label>
                            <p style="color: #666; font-size: 0.85rem; margin: 0.5rem 0;">Sélectionnez une ou plusieurs UFR où ce professeur enseigne</p>
                            <input type="search" id="search-prof-ufr" 
                                   placeholder="🔍 Rechercher une UFR..." 
                                   oninput="filterCheckboxes('search-prof-ufr', 'prof-ufr-checkboxes')"
                                   style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                            <div id="prof-ufr-checkboxes" class="checkbox-group" style="max-height: 200px; overflow-y: auto; border: 1.5px solid var(--border); border-radius: var(--radius); padding: 0.5rem; background: #fafafa;">
                                <p style="text-align: center; color: #999; padding: 1rem;">Sélectionnez d'abord une université</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Filières (au moins une requise) <span style="color: #e74c3c;">*</span></label>
                        <p style="color: #666; font-size: 0.85rem; margin: 0.5rem 0;">Sélectionnez une ou plusieurs filières où ce professeur enseigne</p>
                        <input type="search" id="search-prof-filiere" 
                               placeholder="🔍 Rechercher une filière..." 
                               oninput="filterCheckboxes('search-prof-filiere', 'prof-filiere-checkboxes')"
                               style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                        <div id="prof-filiere-checkboxes" class="checkbox-group" style="max-height: 200px; overflow-y: auto; border: 1.5px solid var(--border); border-radius: var(--radius); padding: 0.5rem; background: #fafafa;">
                            <p style="text-align: center; color: #999; padding: 1rem;">Sélectionnez d'abord au moins une UFR</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialite">Spécialité du professeur</label>
                        <input type="text" id="specialite" name="specialite" required placeholder="Ex: Docteur en Mathématiques, Expert en Physique, etc.">
                    </div>
                    
                    <button type="submit" class="btn">Créer le professeur</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Onglet Étudiants -->
        <div id="content-etudiant" class="tab-content">
            <div class="card">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;" onclick="toggleSection('etudiant-list')">
                    <span>👨‍🎓 Étudiants ({{ etudiants|length }})</span>
                    <span id="arrow-etudiant-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="etudiant-list" style="display: none;">
                    <input type="search" id="search-etudiant" class="search-input" 
                           placeholder="🔍 Rechercher un étudiant..." 
                           onkeyup="searchEtudiant()">
                    <div id="etudiant-count" class="search-result-count"></div>
                    <div class="prof-list" id="etudiant-items">
                        {% if etudiants %}
                            {% set ns = namespace(ufrs_traitees=[]) %}
                            {% for ufr in ufrs %}
                                {% set etudiants_ufr = [] %}
                                {% for etudiant in etudiants %}
                                    {% if etudiant.ufr_id == ufr.id %}
                                        {% set _ = etudiants_ufr.append(etudiant) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if etudiants_ufr|length > 0 %}
                                    <div style="margin-bottom: 2rem; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.6rem 1rem; font-weight: 600; font-size: 0.95rem;">
                                            🏢 {{ ufr.nom }}
                                            {% for uni in universites %}
                                                {% if uni.id == ufr.universite_id %}
                                                    <span style="opacity: 0.9; font-size: 0.9rem; font-weight: 400;"> - {{ uni.nom }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                        {% for filiere in filieres %}
                                            {% set etudiants_filiere = [] %}
                                            {% for etudiant in etudiants_ufr %}
                                                {% if etudiant.filiere_id == filiere.id %}
                                                    {% set _ = etudiants_filiere.append(etudiant) %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if etudiants_filiere|length > 0 %}
                                                {% set filiere_index = loop.index %}
                                                <div style="border-bottom: 1px solid #e0e0e0;">
                                                    <div style="background: linear-gradient(135deg, 
                                                        {% if filiere_index % 5 == 1 %}#e3f2fd, #bbdefb
                                                        {% elif filiere_index % 5 == 2 %}#f3e5f5, #e1bee7
                                                        {% elif filiere_index % 5 == 3 %}#fff3e0, #ffe0b2
                                                        {% elif filiere_index % 5 == 4 %}#e8f5e9, #c8e6c9
                                                        {% else %}#fce4ec, #f8bbd0
                                                        {% endif %}); 
                                                        padding: 0.5rem 1rem; font-weight: 600; font-size: 0.9rem;
                                                        color: {% if filiere_index % 5 == 1 %}#1565c0
                                                        {% elif filiere_index % 5 == 2 %}#6a1b9a
                                                        {% elif filiere_index % 5 == 3 %}#e65100
                                                        {% elif filiere_index % 5 == 4 %}#2e7d32
                                                        {% else %}#c2185b
                                                        {% endif %}; 
                                                        border-left: 4px solid {% if filiere_index % 5 == 1 %}#2196f3
                                                        {% elif filiere_index % 5 == 2 %}#9c27b0
                                                        {% elif filiere_index % 5 == 3 %}#ff9800
                                                        {% elif filiere_index % 5 == 4 %}#4caf50
                                                        {% else %}#e91e63
                                                        {% endif %}; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem;" 
                                                        onclick="toggleFiliereEtudiants('filiere-{{ ufr.id }}-{{ filiere.id }}')">
                                                        <span id="arrow-filiere-{{ ufr.id }}-{{ filiere.id }}" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                                                        <span>📚 {{ filiere.nom }} ({{ etudiants_filiere|length }} étudiant{{ 's' if etudiants_filiere|length > 1 else '' }})</span>
                                                    </div>
                                                    
                                                    <div id="content-filiere-{{ ufr.id }}-{{ filiere.id }}" style="display: none;">
                                                    
                                                    {% for niveau in ["L1", "L2", "L3", "M1", "M2"] %}
                                                        {% set etudiants_niveau = [] %}
                                                        {% for etudiant in etudiants_filiere %}
                                                            {% if etudiant.niveau == niveau %}
                                                                {% set _ = etudiants_niveau.append(etudiant) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        
                                                        {% if etudiants_niveau|length > 0 %}
                                                            <div style="background: linear-gradient(135deg,
                                                                {% if niveau == 'L1' %}#f3e5f5, #e1bee7
                                                                {% elif niveau == 'L2' %}#e8d5f1, #d1b3e3
                                                                {% elif niveau == 'L3' %}#ddc5e8, #ce93d8
                                                                {% elif niveau == 'M1' %}#d1b3e3, #ba68c8
                                                                {% elif niveau == 'M2' %}#ce93d8, #ab47bc
                                                                {% endif %}); 
                                                                padding: 0.4rem 1rem 0.4rem 2rem; font-weight: 600; 
                                                                color: {% if niveau == 'L1' %}#6a1b9a
                                                                {% elif niveau == 'L2' %}#6a1b9a
                                                                {% elif niveau == 'L3' %}#6a1b9a
                                                                {% elif niveau == 'M1' %}#6a1b9a
                                                                {% elif niveau == 'M2' %}#4a148c
                                                                {% endif %}; 
                                                                font-size: 0.85rem; border-left: 4px solid 
                                                                {% if niveau == 'L1' %}#9C27B0
                                                                {% elif niveau == 'L2' %}#8e24aa
                                                                {% elif niveau == 'L3' %}#7b1fa2
                                                                {% elif niveau == 'M1' %}#ab47bc
                                                                {% elif niveau == 'M2' %}#9c27b0
                                                                {% endif %}; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem;" 
                                                                onclick="toggleNiveauEtudiants('niveau-{{ ufr.id }}-{{ filiere.id }}-{{ niveau }}')">
                                                                <span id="arrow-niveau-{{ ufr.id }}-{{ filiere.id }}-{{ niveau }}" style="font-size: 0.9rem; transition: transform 0.3s;">►</span>
                                                                <span>{% if niveau == "L1" %}📘
                                                                {% elif niveau == "L2" %}📗
                                                                {% elif niveau == "L3" %}📙
                                                                {% elif niveau == "M1" %}📕
                                                                {% elif niveau == "M2" %}📔
                                                                {% endif %} {{ niveau }} - {{ etudiants_niveau|length }} étudiant{{ 's' if etudiants_niveau|length > 1 else '' }}</span>
                                                            </div>
                                                            
                                                            <div id="content-niveau-{{ ufr.id }}-{{ filiere.id }}-{{ niveau }}" style="display: none;">
                                                            {% for etudiant in etudiants_niveau %}
                                                                <div class="prof-item academic-item" style="margin: 0; border-radius: 0; border-bottom: 1px solid #f0f0f0; padding-left: 3rem;">
                                                                    <div style="flex: 1;">
                                                                        <div class="prof-name" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;" onclick="toggleUserDetails('etudiant-{{ etudiant.username }}')">
                                                                            <span id="arrow-etudiant-{{ etudiant.username }}" style="font-size: 0.9rem; transition: transform 0.3s;">►</span>
                                                                            <span>{{ etudiant.prenom }} {{ etudiant.nom }}</span>
                                                                        </div>
                                                                        <div id="details-etudiant-{{ etudiant.username }}" style="display: none;">
                                                                            <div class="prof-details">@{{ etudiant.username }}</div>
                                                                            <div class="prof-meta" style="margin-top: 0.5rem;">
                                                                                <span class="meta-tag" style="background: #f3e5f5; color: #7b1fa2;">📅 {{ etudiant.created_at.strftime('%d/%m/%Y à %H:%M') }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="action-buttons" id="actions-etudiant-{{ etudiant.username }}" style="display: none;">
                                                                        <button class="btn-delete btn-small" onclick='deleteEtudiant({{ etudiant.username|tojson }}, {{ (etudiant.prenom ~ " " ~ etudiant.nom)|tojson }})' title="Supprimer">
                                                                            🗑️
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>👨‍🎓 Aucun étudiant inscrit</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Universités -->
        <div id="content-universite" class="tab-content">
            <!-- Vue liste -->
            <div id="universite-list-view">
                {% if admin.is_main_admin %}
                <button onclick="toggleForm('universite')" class="create-btn">
                    ➕ Créer une université
                </button>
                {% else %}
                <div style="background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%); border-left: 4px solid #9C27B0; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #7B1FA2; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ℹ️</span>
                        <span>En tant qu'administrateur secondaire, vous ne pouvez pas créer de nouvelles universités. Cette action est réservée à l'administrateur principal.</span>
                    </p>
                </div>
                {% endif %}
                
                <div class="card">
                    <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;" onclick="toggleSection('universite-list')">
                        <span>📋 Universités ({{ universites|length }})</span>
                        <span id="arrow-universite-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                    </h3>
                    <div id="universite-list" style="display: none;">
                    <input type="search" id="search-universite" class="search-input" 
                           placeholder="🔍 Rechercher une université..." 
                           onkeyup="searchUniversite()">
                    <div id="universite-count" class="search-result-count"></div>
                    <div class="prof-list" id="universite-items">
                        {% if universites %}
                            {% for uni in universites %}
                            <div class="academic-item">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    {% if uni.logo_url %}
                                        <img src="{{ uni.logo_url }}" alt="Logo {{ uni.nom }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                                    {% else %}
                                        <div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd;">
                                            🏛️
                                        </div>
                                    {% endif %}
                                    <div style="flex-grow: 1;">
                                        <h4>{{ uni.nom }}</h4>
                                        <div class="academic-code">Code: {{ uni.code }}</div>
                                    </div>
                                </div>
                                <div class="action-buttons" style="margin-top: 0.5rem;">
                                    <button class="btn-edit btn-small" onclick='editUniversite({{ uni.id|tojson }}, {{ uni.nom|tojson }}, {{ uni.code|tojson }})' title="Modifier">
                                        ✏️
                                    </button>
                                    <button class="btn-small" onclick='uploadLogo({{ uni.id|tojson }}, {{ uni.nom|tojson }})' style="background: #9C27B0; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" title="Ajouter un logo">
                                        📸
                                    </button>
                                    <button class="btn-delete btn-small" onclick='deleteUniversite({{ uni.id|tojson }}, {{ uni.nom|tojson }})' title="Supprimer">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>🏛️ Aucune université créée</p>
                            </div>
                        {% endif %}
                    </div>
                    </div>
                </div>
                
                <!-- Formulaire d'upload de logo (caché par défaut) -->
                <div id="logoUploadForm" style="display: none;" class="card">
                    <h3>📸 Ajouter un logo à l'université</h3>
                    <form id="logoForm" action="/admin/upload-logo" method="post" enctype="multipart/form-data">
                        <input type="hidden" id="logoUniversiteId" name="universite_id">
                        <div class="form-group">
                            <label for="logoFile">Choisir un logo (JPG, PNG, GIF)</label>
                            <input type="file" id="logoFile" name="logo" accept="image/*" required>
                            <small style="color: #666;">Taille recommandée: 500x500 pixels maximum</small>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="submit" class="btn">📸 Télécharger le logo</button>
                            <button type="button" class="btn" style="background: #666;" onclick="cancelLogoUpload()">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Formulaire de création (caché par défaut) -->
            <div id="universite-form-view" class="hidden">
                <div class="card" style="position: relative;">
                    <button type="button" onclick="toggleForm('universite')" class="cancel-btn" title="Annuler">✕</button>
                    <div class="form-header">
                        <h3>🏛️ Créer une université</h3>
                    </div>
                    <form action="/admin/create-universite" method="post">
                        <div class="form-group">
                            <label for="uni-nom">Nom de l'université</label>
                            <input type="text" id="uni-nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="uni-code">Code université</label>
                            <input type="text" id="uni-code" name="code" required>
                        </div>
                        <button type="submit" class="btn">Créer l'université</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Onglet UFR -->
        <div id="content-ufr" class="tab-content">
            <!-- Vue liste -->
            <div id="ufr-list-view">
                <button onclick="toggleForm('ufr')" class="create-btn">
                    ➕ Créer une UFR
                </button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem;" onclick="toggleSection('ufr-list')">
                            <span>📋 UFR ({{ ufrs|length }})</span>
                            <span id="arrow-ufr-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                        </h3>
                        <input type="search" id="search-ufr" 
                               placeholder="🔍 Rechercher..." 
                               oninput="searchUfr()"
                               style="width: 200px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; transition: border-color 0.3s;">
                    </div>
                    <div id="ufr-list" style="display: none;">
                    <div id="ufr-count" style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; font-style: italic;"></div>
                    <div class="prof-list" id="ufr-items">
                        {% if ufrs %}
                            {% for ufr in ufrs %}
                            <div class="academic-item">
                                <h4>{{ ufr.nom }}</h4>
                                <div class="academic-code">Code: {{ ufr.code }}</div>
                                <div style="color: #666; font-size: 0.9rem;">
                                    {% for uni in universites %}
                                        {% if uni.id == ufr.universite_id %}
                                            Université: {{ uni.nom }}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn-edit btn-small" onclick='editUfr({{ ufr.id|tojson }}, {{ ufr.nom|tojson }}, {{ ufr.code|tojson }})' title="Modifier">
                                        ✏️
                                    </button>
                                    <button class="btn-delete btn-small" onclick='deleteUfr({{ ufr.id|tojson }}, {{ ufr.nom|tojson }})' title="Supprimer">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>🏢 Aucune UFR créée</p>
                            </div>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulaire de création (caché par défaut) -->
            <div id="ufr-form-view" class="hidden">
                <div class="card" style="position: relative;">
                    <button type="button" onclick="toggleForm('ufr')" class="cancel-btn" title="Annuler">✕</button>
                    <div class="form-header">
                        <h3>🏢 Créer une UFR</h3>
                    </div>
                    <form action="/admin/create-ufr" method="post">
                        <div class="form-group">
                            <label for="ufr-universite">Université</label>
                            <input type="search" id="search-ufr-universite" 
                                   placeholder="🔍 Rechercher une université..." 
                                   oninput="filterSelectOptions('search-ufr-universite', 'ufr-universite')"
                                   style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                            <select id="ufr-universite" name="universite_id" required>
                                <option value="">Sélectionner une université</option>
                                {% for uni in universites %}
                                <option value="{{ uni.id }}">{{ uni.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ufr-nom">Nom de l'UFR</label>
                            <input type="text" id="ufr-nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="ufr-code">Code UFR</label>
                            <input type="text" id="ufr-code" name="code" required>
                        </div>
                        <button type="submit" class="btn">Créer l'UFR</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Onglet Filières -->
        <div id="content-filiere" class="tab-content">
            <!-- Vue liste -->
            <div id="filiere-list-view">
                <button onclick="toggleForm('filiere')" class="create-btn">
                    ➕ Créer une filière
                </button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem;" onclick="toggleSection('filiere-list')">
                            <span>📋 Filières ({{ filieres|length }})</span>
                            <span id="arrow-filiere-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                        </h3>
                        <input type="search" id="search-filiere" 
                               placeholder="🔍 Rechercher..." 
                               oninput="searchFiliere()"
                               style="width: 200px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; transition: border-color 0.3s;">
                    </div>
                    <div id="filiere-list" style="display: none;">
                    <div id="filiere-count" style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; font-style: italic;"></div>
                    <div class="prof-list" id="filiere-items">
                        {% if filieres %}
                            {% for filiere in filieres %}
                            <div class="academic-item">
                                <h4>{{ filiere.nom }}</h4>
                                <div class="academic-code">Code: {{ filiere.code }}</div>
                                <div style="color: #666; font-size: 0.9rem;">
                                    {% for ufr in ufrs %}
                                        {% if ufr.id == filiere.ufr_id %}
                                            UFR: {{ ufr.nom }}
                                            {% for uni in universites %}
                                                {% if uni.id == ufr.universite_id %}
                                                    ({{ uni.nom }})
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn-edit btn-small" onclick='editFiliere({{ filiere.id|tojson }}, {{ filiere.nom|tojson }}, {{ filiere.code|tojson }})' title="Modifier">
                                        ✏️
                                    </button>
                                    <button class="btn-delete btn-small" onclick='deleteFiliere({{ filiere.id|tojson }}, {{ filiere.nom|tojson }})' title="Supprimer">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>📚 Aucune filière créée</p>
                            </div>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulaire de création (caché par défaut) -->
            <div id="filiere-form-view" class="hidden">
                <div class="card" style="position: relative;">
                    <button type="button" onclick="toggleForm('filiere')" class="cancel-btn" title="Annuler">✕</button>
                    <div class="form-header">
                        <h3>📚 Créer une filière</h3>
                    </div>
                    <form action="/admin/create-filiere" method="post">
                        <div class="form-group">
                            <label for="fil-ufr">UFR</label>
                            <input type="search" id="search-fil-ufr" 
                                   placeholder="🔍 Rechercher une UFR..." 
                                   oninput="filterSelectOptions('search-fil-ufr', 'fil-ufr')"
                                   style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                            <select id="fil-ufr" name="ufr_id" required>
                                <option value="">Sélectionner une UFR</option>
                                {% for ufr in ufrs %}
                                <option value="{{ ufr.id }}">{{ ufr.nom }}
                                    {% for uni in universites %}
                                        {% if uni.id == ufr.universite_id %}
                                            ({{ uni.nom }})
                                        {% endif %}
                                    {% endfor %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fil-nom">Nom de la filière</label>
                            <input type="text" id="fil-nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="fil-code">Code filière</label>
                            <input type="text" id="fil-code" name="code" required>
                        </div>
                        <button type="submit" class="btn">Créer la filière</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Onglet Matières -->
        <div id="content-matiere" class="tab-content">
            <!-- Vue liste -->
            <div id="matiere-list-view">
                <button onclick="toggleForm('matiere')" class="create-btn">
                    ➕ Créer une matière
                </button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 0.5rem;" onclick="toggleSection('matiere-list')">
                            <span>📋 Matières ({{ matieres|length }})</span>
                            <span id="arrow-matiere-list" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                        </h3>
                        <input type="search" id="search-matiere" 
                               placeholder="🔍 Rechercher..." 
                               oninput="searchMatiere()"
                               style="width: 200px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; transition: border-color 0.3s;">
                    </div>
                    <div id="matiere-list" style="display: none;">
                    <div id="matiere-count" style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; font-style: italic;"></div>
                    <div class="prof-list" id="matiere-items">
                        {% if matieres %}
                            {% set ns = namespace(filieres_traitees=[]) %}
                            {% for filiere in filieres %}
                                {% set matieres_filiere = [] %}
                                {% for matiere in matieres %}
                                    {% if matiere.filiere_id == filiere.id %}
                                        {% set _ = matieres_filiere.append(matiere) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if matieres_filiere|length > 0 %}
                                    <div style="margin-bottom: 2rem; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.6rem 1rem; font-weight: 600; font-size: 0.95rem;">
                                            {{ filiere.nom }}
                                            {% for ufr in ufrs %}
                                                {% if ufr.id == filiere.ufr_id %}
                                                    <span style="opacity: 0.9; font-size: 0.9rem; font-weight: 400;"> - {{ ufr.nom }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                        {% for niveau in ["L1", "L2", "L3", "M1", "M2"] %}
                                            {% set matieres_niveau = [] %}
                                            {% for matiere in matieres_filiere %}
                                                {% if matiere.niveau == niveau %}
                                                    {% set _ = matieres_niveau.append(matiere) %}
                                                {% endif %}
                                            {% endfor %}
                                            
                                            {% if matieres_niveau|length > 0 %}
                                                <div style="border-bottom: 1px solid #e0e0e0;">
                                                    <div style="background: linear-gradient(135deg, 
                                                        {% if niveau == 'L1' %}#9C27B0, #BA68C8
                                                        {% elif niveau == 'L2' %}#8e24aa, #ab47bc
                                                        {% elif niveau == 'L3' %}#7b1fa2, #9c27b0
                                                        {% elif niveau == 'M1' %}#ab47bc, #ba68c8
                                                        {% elif niveau == 'M2' %}#9c27b0, #ab47bc
                                                        {% endif %}); 
                                                        padding: 0.5rem 1rem; font-weight: 600; color: white; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;"
                                                        onclick="toggleNiveauMatieres('{{ filiere.id }}_{{ niveau }}')">
                                                        <span>
                                                            {% if niveau == "L1" %}📘 Licence 1 (L1)
                                                            {% elif niveau == "L2" %}📗 Licence 2 (L2)
                                                            {% elif niveau == "L3" %}📙 Licence 3 (L3)
                                                            {% elif niveau == "M1" %}📕 Master 1 (M1)
                                                            {% elif niveau == "M2" %}📔 Master 2 (M2)
                                                            {% endif %}
                                                        </span>
                                                        <span id="arrow-niveau-{{ filiere.id }}_{{ niveau }}" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                                                    </div>
                                                    <div id="content-niveau-{{ filiere.id }}_{{ niveau }}" style="display: none;">
                                                    
                                                    {% for semestre in ["S1", "S2"] %}
                                                        {% set matieres_semestre = [] %}
                                                        {% for matiere in matieres_niveau %}
                                                            {% if matiere.semestre == semestre %}
                                                                {% set _ = matieres_semestre.append(matiere) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        
                                                        {% if matieres_semestre|length > 0 %}
                                                            <div style="background: linear-gradient(135deg, 
                                                                {% if semestre == 'S1' %}#667eea, #764ba2
                                                                {% else %}#f093fb, #f5576c
                                                                {% endif %}); 
                                                                padding: 0.4rem 1rem 0.4rem 1.5rem; font-weight: 600; color: white; font-size: 0.85rem; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;"
                                                                onclick="toggleSemestreMatieres('{{ filiere.id }}_{{ niveau }}_{{ semestre }}')">
                                                                <span>📅 {{ semestre }} - Semestre {{ semestre[1] }}</span>
                                                                <span id="arrow-semestre-{{ filiere.id }}_{{ niveau }}_{{ semestre }}" style="font-size: 1rem; transition: transform 0.3s;">►</span>
                                                            </div>
                                                            <div id="content-semestre-{{ filiere.id }}_{{ niveau }}_{{ semestre }}" style="display: none;">
                                                            {% for matiere in matieres_semestre %}
                                                                <div class="academic-item" style="margin: 0; border-radius: 0; border-bottom: 1px solid #f0f0f0; padding-left: 3rem;">
                                                                    <h4 style="margin: 0;">{{ matiere.nom }}</h4>
                                                                    <div class="academic-code">Code: {{ matiere.code }}</div>
                                                                    <div class="action-buttons">
                                                                        <button class="btn-edit btn-small" onclick='editMatiere({{ matiere.id|tojson }}, {{ matiere.nom|tojson }}, {{ matiere.code|tojson }})' title="Modifier">
                                                                            ✏️
                                                                        </button>
                                                                        <button class="btn-delete btn-small" onclick='deleteMatiere({{ matiere.id|tojson }}, {{ matiere.nom|tojson }})' title="Supprimer">
                                                                            🗑️
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <p>📖 Aucune matière créée</p>
                            </div>
                        {% endif %}
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulaire de création (caché par défaut) -->
            <div id="matiere-form-view" class="hidden">
                <div class="card" style="position: relative;">
                    <button type="button" onclick="toggleForm('matiere')" class="cancel-btn" title="Annuler">✕</button>
                    <div class="form-header">
                        <h3>📖 Créer une matière</h3>
                    </div>
                    <form action="/admin/create-matiere" method="post">
                        <div class="form-group">
                            <label for="mat-filiere">Filière</label>
                            <input type="search" id="search-mat-filiere" 
                                   placeholder="🔍 Rechercher une filière..." 
                                   oninput="filterSelectOptions('search-mat-filiere', 'mat-filiere')"
                                   style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 1rem; margin-bottom: 0.5rem; transition: all 0.3s;">
                            <select id="mat-filiere" name="filiere_id" required>
                                <option value="">Sélectionner une filière</option>
                                {% for filiere in filieres %}
                                <option value="{{ filiere.id }}">{{ filiere.nom }}
                                    {% for ufr in ufrs %}
                                        {% if ufr.id == filiere.ufr_id %}
                                            ({{ ufr.nom }})
                                        {% endif %}
                                    {% endfor %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="mat-niveau">Niveau</label>
                            <select id="mat-niveau" name="niveau" required>
                                <option value="">Sélectionner un niveau</option>
                                <option value="L1">📘 Licence 1 (L1)</option>
                                <option value="L2">📗 Licence 2 (L2)</option>
                                <option value="L3">📙 Licence 3 (L3)</option>
                                <option value="M1">📕 Master 1 (M1)</option>
                                <option value="M2">📔 Master 2 (M2)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="mat-semestre">Semestre</label>
                            <select id="mat-semestre" name="semestre" required>
                                <option value="">Sélectionner un semestre</option>
                                <option value="S1">📅 Semestre 1 (S1)</option>
                                <option value="S2">📅 Semestre 2 (S2)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="mat-nom">Nom de la matière</label>
                            <input type="text" id="mat-nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="mat-code">Code matière</label>
                            <input type="text" id="mat-code" name="code" required>
                        </div>
                        <button type="submit" class="btn">Créer la matière</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglet Hiérarchie de passage -->
    <div id="content-passage" class="tab-content">
        <div class="card">
            <!-- Formulaire de création -->
            <div id="passage-form-view">
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 0 0 1rem;" onclick="toggleSection('passage-creation')">
                    <span>🎓 Créer une règle de passage</span>
                    <span id="arrow-passage-creation" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="passage-creation" style="display: none;">
                    <div class="card" style="position: relative;">
                        <form action="/admin/create-passage" method="post">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="passage-filiere-depart">Filière de départ</label>
                                <select id="passage-filiere-depart" name="filiere_depart_id" required>
                                    <option value="">Sélectionner une filière</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="passage-niveau-depart">Niveau de départ</label>
                                <select id="passage-niveau-depart" name="niveau_depart" required>
                                    <option value="">Sélectionner un niveau</option>
                                    <option value="L1">L1</option>
                                    <option value="L2">L2</option>
                                    <option value="L3">L3</option>
                                    <option value="M1">M1</option>
                                    <option value="M2">M2</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Checkbox pour passage dans la même filière -->
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #3b82f6;">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 500; color: #1e40af;">
                                <input type="checkbox" id="passage-meme-filiere" style="width: 20px; height: 20px; cursor: pointer;">
                                <span>☑️ Passage dans la même filière (ex: L1 MPCI → L2 MPCI)</span>
                            </label>
                            <p style="margin: 0.5rem 0 0 2rem; font-size: 0.85rem; color: #475569;">
                                Cochez cette option si l'étudiant reste dans sa filière actuelle mais passe au niveau supérieur.
                            </p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="passage-filiere-arrivee">Filière d'arrivée</label>
                                <select id="passage-filiere-arrivee" name="filiere_arrivee_id" required>
                                    <option value="">Sélectionner une filière</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="passage-niveau-arrivee">Niveau d'arrivée</label>
                                <select id="passage-niveau-arrivee" name="niveau_arrivee" required>
                                    <option value="">Sélectionner un niveau</option>
                                    <option value="L1">L1</option>
                                    <option value="L2">L2</option>
                                    <option value="L3">L3</option>
                                    <option value="M1">M1</option>
                                    <option value="M2">M2</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn">Créer la règle de passage</button>
                    </form>
                    </div>
                </div>
            </div>
            
            <!-- Vue liste -->
            <div id="passage-list-view">
                
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 2rem 0 1rem;" onclick="toggleSection('passage-regles')">
                    <span>📘 Règles de passage existantes</span>
                    <span id="arrow-passage-regles" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="passage-regles" style="display: none;">
                    <div id="passage-list-container">
                        <p style="text-align: center; color: #666; padding: 1rem;">Chargement des règles...</p>
                    </div>
                </div>
                
                <h3 style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; margin: 2rem 0 1rem;" onclick="toggleSection('passage-stats')">
                    <span>📊 Statistiques des passages</span>
                    <span id="arrow-passage-stats" style="font-size: 1.2rem; transition: transform 0.3s;">►</span>
                </h3>
                <div id="passage-stats" style="display: none;">
                    <div id="passage-stats-container">
                        <p style="text-align: center; color: #666; padding: 1rem;">Chargement des statistiques...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Masquer tous les contenus
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Désactiver tous les boutons
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Afficher le contenu sélectionné
            document.getElementById('content-' + tabName).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        // Variable globale pour stocker l'université sélectionnée (admin principal uniquement)
        let selectedUniversiteId = null;
        
        // Charger les paramètres d'une université sélectionnée (admin principal)
        async function loadUniversiteSettings() {
            const selector = document.getElementById('universite-selector');
            const controlsContainer = document.getElementById('controls-container');
            
            selectedUniversiteId = selector.value;
            
            if (!selectedUniversiteId) {
                // Masquer les contrôles si aucune université n'est sélectionnée
                controlsContainer.style.display = 'none';
                return;
            }
            
            // Afficher les contrôles
            controlsContainer.style.display = 'flex';
            
            // Charger les statuts pour l'université sélectionnée
            await loadDownloadStatus();
            await loadPassageClasseStatus();
        }
        
        // Toggle des téléchargements (admin uniquement)
        async function toggleTelechargements() {
            const statusSpan = document.getElementById('download-status');
            const iconSpan = document.getElementById('download-icon');
            const btn = document.getElementById('download-toggle-btn');
            
            try {
                // Désactiver le bouton pendant l'action
                btn.disabled = true;
                statusSpan.textContent = ': Traitement...';
                
                // Préparer le body avec universite_id si admin principal
                const body = selectedUniversiteId ? JSON.stringify({ universite_id: selectedUniversiteId }) : null;
                
                const response = await fetch('/api/parametres/telechargements/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateDownloadButtonStatus(data.actif);
                    showAlert(data.message, 'success');
                } else {
                    showAlert('Erreur lors du changement d\'état', 'error');
                    await loadDownloadStatus(); // Recharger l'état réel
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de communication avec le serveur', 'error');
                await loadDownloadStatus(); // Recharger l'état réel
            } finally {
                btn.disabled = false;
            }
        }
        
        // Mettre à jour l'affichage du bouton
        function updateDownloadButtonStatus(actif) {
            const statusSpan = document.getElementById('download-status');
            const iconSpan = document.getElementById('download-icon');
            const btn = document.getElementById('download-toggle-btn');
            
            if (actif) {
                statusSpan.textContent = ': Activés ✓';
                btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)';
            } else {
                statusSpan.textContent = ': Désactivés ✗';
                btn.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
            }
        }
        
        // Charger l'état des téléchargements au démarrage
        async function loadDownloadStatus() {
            try {
                // Ajouter universite_id en query param si admin principal
                const url = selectedUniversiteId 
                    ? `/api/parametres/telechargements?universite_id=${selectedUniversiteId}`
                    : '/api/parametres/telechargements';
                    
                const response = await fetch(url);
                const data = await response.json();
                updateDownloadButtonStatus(data.actif);
            } catch (error) {
                console.error('Erreur lors du chargement de l\'état:', error);
                document.getElementById('download-status').textContent = ': Erreur';
            }
        }
        
        // Charger l'état des téléchargements au démarrage
        window.addEventListener('DOMContentLoaded', function() {
            loadDownloadStatus();
            loadPassageClasseStatus();
        });
        
        // === CONTRÔLE DU PASSAGE EN CLASSE SUPÉRIEURE ===
        
        // Basculer l'état du passage en classe supérieure
        async function togglePassageClasse() {
            const statusSpan = document.getElementById('passage-status');
            const iconSpan = document.getElementById('passage-icon');
            const btn = document.getElementById('passage-toggle-btn');
            
            try {
                // Désactiver le bouton pendant l'action
                btn.disabled = true;
                statusSpan.textContent = ': Traitement...';
                
                // Préparer le body avec universite_id si admin principal
                const body = selectedUniversiteId ? JSON.stringify({ universite_id: selectedUniversiteId }) : null;
                
                const response = await fetch('/api/parametres/passage-classe/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updatePassageClasseButtonStatus(data.actif);
                    showAlert(data.message, 'success');
                } else {
                    showAlert('Erreur lors du changement d\'état', 'error');
                    await loadPassageClasseStatus(); // Recharger l'état réel
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de communication avec le serveur', 'error');
                await loadPassageClasseStatus(); // Recharger l'état réel
            } finally {
                btn.disabled = false;
            }
        }
        
        // Mettre à jour l'affichage du bouton passage
        function updatePassageClasseButtonStatus(actif) {
            const statusSpan = document.getElementById('passage-status');
            const iconSpan = document.getElementById('passage-icon');
            const btn = document.getElementById('passage-toggle-btn');
            
            if (actif) {
                statusSpan.textContent = ': Activé ✓';
                btn.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
            } else {
                statusSpan.textContent = ': Désactivé ✗';
                btn.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
            }
        }
        
        // Charger l'état du passage en classe supérieure au démarrage
        async function loadPassageClasseStatus() {
            try {
                // Ajouter universite_id en query param si admin principal
                const url = selectedUniversiteId 
                    ? `/api/parametres/passage-classe?universite_id=${selectedUniversiteId}`
                    : '/api/parametres/passage-classe';
                    
                const response = await fetch(url);
                const data = await response.json();
                updatePassageClasseButtonStatus(data.actif);
            } catch (error) {
                console.error('Erreur lors du chargement de l\'état:', error);
                document.getElementById('passage-status').textContent = ': Erreur';
            }
        }
        
        // === FIN CONTRÔLE DU PASSAGE EN CLASSE SUPÉRIEURE ===
        
        // Gestion des checkboxes multiples pour le formulaire professeur
        const profUniversiteSelect = document.getElementById('prof-universite');
        const profUfrCheckboxes = document.getElementById('prof-ufr-checkboxes');
        const profFiliereCheckboxes = document.getElementById('prof-filiere-checkboxes');
        
        // Fonction pour filtrer les checkboxes
        function filterCheckboxes(searchInputId, checkboxContainerId) {
            const searchTerm = document.getElementById(searchInputId).value.toLowerCase();
            const container = document.getElementById(checkboxContainerId);
            const labels = container.querySelectorAll('label');
            
            labels.forEach(label => {
                const text = label.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    label.style.display = 'flex';
                } else {
                    label.style.display = 'none';
                }
            });
        }
        
        // Charge les UFR quand une université est sélectionnée
        profUniversiteSelect.addEventListener('change', async function() {
            const universiteId = this.value;
            
            // Réinitialise les checkboxes
            profUfrCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Chargement...</p>';
            profFiliereCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Sélectionnez d\'abord au moins une UFR</p>';
            
            if (universiteId) {
                try {
                    const response = await fetch(`/api/ufrs/${universiteId}`);
                    const data = await response.json();
                    
                    if (data.ufrs.length === 0) {
                        profUfrCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Aucune UFR disponible</p>';
                        return;
                    }
                    
                    profUfrCheckboxes.innerHTML = '';
                    data.ufrs.forEach(ufr => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 4px; transition: background 0.2s;';
                        label.onmouseover = () => label.style.background = '#e3f2fd';
                        label.onmouseout = () => label.style.background = 'transparent';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'ufr_ids';
                        checkbox.value = ufr.id;
                        checkbox.style.cssText = 'margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;';
                        checkbox.addEventListener('change', updateFiliereCheckboxes);
                        
                        const span = document.createElement('span');
                        span.textContent = ufr.nom;
                        span.style.cssText = 'flex: 1; font-size: 0.95rem;';
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        profUfrCheckboxes.appendChild(label);
                    });
                } catch (error) {
                    console.error('Erreur lors du chargement des UFR:', error);
                    profUfrCheckboxes.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 1rem;">Erreur lors du chargement</p>';
                }
            } else {
                profUfrCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Sélectionnez d\'abord une université</p>';
            }
        });
        
        // Met à jour les filières en fonction des UFR sélectionnées
        async function updateFiliereCheckboxes() {
            const selectedUfrIds = Array.from(document.querySelectorAll('input[name="ufr_ids"]:checked')).map(cb => cb.value);
            
            if (selectedUfrIds.length === 0) {
                profFiliereCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Sélectionnez d\'abord au moins une UFR</p>';
                return;
            }
            
            profFiliereCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Chargement...</p>';
            
            try {
                // Charger les filières pour toutes les UFR sélectionnées
                const allFilieres = new Map(); // Utilise Map pour éviter les doublons
                
                for (const ufrId of selectedUfrIds) {
                    const response = await fetch(`/api/filieres/${ufrId}`);
                    const data = await response.json();
                    data.filieres.forEach(filiere => {
                        allFilieres.set(filiere.id, filiere);
                    });
                }
                
                if (allFilieres.size === 0) {
                    profFiliereCheckboxes.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Aucune filière disponible</p>';
                    return;
                }
                
                profFiliereCheckboxes.innerHTML = '';
                allFilieres.forEach(filiere => {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 4px; transition: background 0.2s;';
                    label.onmouseover = () => label.style.background = '#f3e5f5';
                    label.onmouseout = () => label.style.background = 'transparent';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'filiere_ids';
                    checkbox.value = filiere.id;
                    checkbox.style.cssText = 'margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;';
                    
                    const span = document.createElement('span');
                    span.textContent = filiere.nom;
                    span.style.cssText = 'flex: 1; font-size: 0.95rem;';
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    profFiliereCheckboxes.appendChild(label);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des filières:', error);
                profFiliereCheckboxes.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 1rem;">Erreur lors du chargement</p>';
            }
        }
        
        // Validation du formulaire professeur (sans soumettre)
        document.querySelector('form[action="/admin/create-prof"]').addEventListener('submit', function(e) {
            const selectedUfrs = document.querySelectorAll('input[name="ufr_ids"]:checked');
            const selectedFilieres = document.querySelectorAll('input[name="filiere_ids"]:checked');
            
            if (selectedUfrs.length === 0) {
                e.preventDefault();
                e.stopImmediatePropagation();
                alert('⚠️ Veuillez sélectionner au moins une UFR');
                return false;
            }
            
            if (selectedFilieres.length === 0) {
                e.preventDefault();
                e.stopImmediatePropagation();
                alert('⚠️ Veuillez sélectionner au moins une filière');
                return false;
            }
            
            // Ne pas retourner true - laisser l'AJAX gérer la soumission
        }, true); // Capturer en phase de capture pour s'exécuter avant l'AJAX
        
        // Fonctions de recherche pour les listes
        function searchUfr() {
            const searchTerm = document.getElementById('search-ufr').value.toLowerCase();
            const items = document.querySelectorAll('#ufr-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('ufr-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} UFRs` : '';
        }
        
        function searchFiliere() {
            const searchTerm = document.getElementById('search-filiere').value.toLowerCase();
            const items = document.querySelectorAll('#filiere-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('filiere-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} filières` : '';
        }
        
        function searchMatiere() {
            const searchTerm = document.getElementById('search-matiere').value.toLowerCase();
            const items = document.querySelectorAll('#matiere-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('matiere-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} matières` : '';
        }
        
        // Toggle niveau des matières
        function toggleNiveauMatieres(niveauId) {
            const content = document.getElementById('content-niveau-' + niveauId);
            const arrow = document.getElementById('arrow-niveau-' + niveauId);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
                arrow.textContent = '►';
            }
        }
        
        // Toggle semestre des matières
        function toggleSemestreMatieres(semestreId) {
            const content = document.getElementById('content-semestre-' + semestreId);
            const arrow = document.getElementById('arrow-semestre-' + semestreId);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
                arrow.textContent = '►';
            }
        }
        
        function searchAdmin() {
            const searchTerm = document.getElementById('search-admin').value.toLowerCase();
            const items = document.querySelectorAll('#admin-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('admin-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} administrateurs` : '';
        }
        
        function searchProf() {
            const searchTerm = document.getElementById('search-prof').value.toLowerCase();
            const items = document.querySelectorAll('#prof-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('prof-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} professeurs` : '';
        }
        
        function searchEtudiant() {
            const searchTerm = document.getElementById('search-etudiant').value.toLowerCase();
            const items = document.querySelectorAll('#etudiant-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('etudiant-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} étudiants` : '';
        }
        
        function searchUniversite() {
            const searchTerm = document.getElementById('search-universite').value.toLowerCase();
            const items = document.querySelectorAll('#universite-items .academic-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            document.getElementById('universite-count').textContent = 
                searchTerm ? `Affichage ${visibleCount} sur ${items.length} universités` : '';
        }
        
        // Fonction pour filtrer les options d'un select en temps réel
        function filterSelectOptions(searchInputId, selectId) {
            const searchTerm = document.getElementById(searchInputId).value.toLowerCase();
            const selectElement = document.getElementById(selectId);
            const options = selectElement.options;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                const text = option.textContent.toLowerCase();
                
                if (text.includes(searchTerm) || option.value === "") {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            }
            
            // Si une option filtrée est sélectionnée, réinitialiser la sélection
            if (selectElement.selectedIndex !== -1) {
                const selectedOption = options[selectElement.selectedIndex];
                if (selectedOption.style.display === 'none') {
                    selectElement.selectedIndex = 0;
                }
            }
        }
        
        // Functions pour les actions CRUD
        
        // Administrateurs
        function editAdmin(username, nom, prenom) {
            const newNom = prompt('Nouveau nom:', nom);
            if (!newNom) return;
            
            const newPrenom = prompt('Nouveau prénom:', prenom);
            if (!newPrenom) return;
            
            const newUsername = prompt('Nouveau nom d\'utilisateur (laisser vide pour ne pas changer):', username);
            const newPassword = prompt('Nouveau mot de passe (laisser vide pour ne pas changer):');
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/edit-admin';
            form.innerHTML = `
                <input type="hidden" name="username" value="${username}">
                <input type="hidden" name="nom" value="${newNom}">
                <input type="hidden" name="prenom" value="${newPrenom}">
                <input type="hidden" name="new_username" value="${newUsername || ''}">
                <input type="hidden" name="new_password" value="${newPassword || ''}">
            `;
            document.body.appendChild(form);
            form.submit();
        }
        
        async function toggleAdminStatus(username, fullName, currentStatus) {
            const action = currentStatus ? 'désactiver' : 'activer';
            if (confirm(`Êtes-vous sûr de vouloir ${action} l'administrateur "${fullName}" ?`)) {
                // Trouver le bouton
                const btn = document.querySelector(`button[data-username="${username}"]`);
                
                // MISE À JOUR OPTIMISTE : Changer le bouton immédiatement
                const optimisticNewStatus = !currentStatus;
                if (btn) {
                    btn.textContent = optimisticNewStatus ? 'ON' : 'OFF';
                    btn.style.background = optimisticNewStatus ? '#28a745' : '#dc3545';
                    btn.title = optimisticNewStatus ? 'Désactiver' : 'Activer';
                    btn.disabled = true; // Désactiver pendant la requête
                }
                
                const formData = new FormData();
                formData.append('username', username);
                
                try {
                    const response = await fetch('/admin/toggle-admin-status', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Confirmer avec le statut du serveur
                        if (btn) {
                            const newStatus = data.new_status;
                            btn.textContent = newStatus ? 'ON' : 'OFF';
                            btn.style.background = newStatus ? '#28a745' : '#dc3545';
                            btn.title = newStatus ? 'Désactiver' : 'Activer';
                            btn.disabled = false;
                            const fullNameFromBtn = btn.dataset.fullname;
                            btn.onclick = () => toggleAdminStatus(username, fullNameFromBtn, newStatus);
                        }
                        alert(`✅ ${data.message}`);
                    } else {
                        // ANNULER le changement optimiste si le serveur refuse
                        if (btn) {
                            btn.textContent = currentStatus ? 'ON' : 'OFF';
                            btn.style.background = currentStatus ? '#28a745' : '#dc3545';
                            btn.title = currentStatus ? 'Désactiver' : 'Activer';
                            btn.disabled = false;
                        }
                        alert(`❌ ${data.error}`);
                    }
                } catch (error) {
                    // ANNULER le changement optimiste en cas d'erreur
                    if (btn) {
                        btn.textContent = currentStatus ? 'ON' : 'OFF';
                        btn.style.background = currentStatus ? '#28a745' : '#dc3545';
                        btn.title = currentStatus ? 'Désactiver' : 'Activer';
                        btn.disabled = false;
                    }
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors du changement de statut');
                }
            }
        }
        
        async function deleteAdmin(username, fullName) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'administrateur "${fullName}" ?\\n\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('username', username);
                
                try {
                    const response = await fetch('/admin/delete-admin', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteAdmin"]');
                        let adminElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${username}'`)) {
                                adminElement = btn.closest('.prof-item');
                            }
                        });
                        if (adminElement) {
                            adminElement.style.transition = 'opacity 0.3s';
                            adminElement.style.opacity = '0';
                            setTimeout(() => adminElement.remove(), 300);
                        }
                        alert(`✅ Administrateur "${fullName}" supprimé avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        async function toggleProfStatus(username, fullName, currentStatus) {
            const action = currentStatus ? 'désactiver' : 'activer';
            if (confirm(`Êtes-vous sûr de vouloir ${action} le professeur "${fullName}" ?`)) {
                // Trouver le bouton
                const btn = document.querySelector(`button[data-username="${username}"]`);
                
                // MISE À JOUR OPTIMISTE : Changer le bouton immédiatement
                const optimisticNewStatus = !currentStatus;
                if (btn) {
                    btn.textContent = optimisticNewStatus ? 'ON' : 'OFF';
                    btn.style.background = optimisticNewStatus ? '#28a745' : '#dc3545';
                    btn.title = optimisticNewStatus ? 'Désactiver' : 'Activer';
                    btn.disabled = true; // Désactiver pendant la requête
                }
                
                const formData = new FormData();
                formData.append('username', username);
                
                try {
                    const response = await fetch('/admin/toggle-prof-status', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Confirmer avec le statut du serveur
                        if (btn) {
                            const newStatus = data.new_status;
                            btn.textContent = newStatus ? 'ON' : 'OFF';
                            btn.style.background = newStatus ? '#28a745' : '#dc3545';
                            btn.title = newStatus ? 'Désactiver' : 'Activer';
                            btn.disabled = false;
                            const fullNameFromBtn = btn.dataset.fullname;
                            btn.onclick = () => toggleProfStatus(username, fullNameFromBtn, newStatus);
                        }
                        alert(`✅ ${data.message}`);
                    } else {
                        // ANNULER le changement optimiste si le serveur refuse
                        if (btn) {
                            btn.textContent = currentStatus ? 'ON' : 'OFF';
                            btn.style.background = currentStatus ? '#28a745' : '#dc3545';
                            btn.title = currentStatus ? 'Désactiver' : 'Activer';
                            btn.disabled = false;
                        }
                        alert(`❌ ${data.error}`);
                    }
                } catch (error) {
                    // ANNULER le changement optimiste en cas d'erreur
                    if (btn) {
                        btn.textContent = currentStatus ? 'ON' : 'OFF';
                        btn.style.background = currentStatus ? '#28a745' : '#dc3545';
                        btn.title = currentStatus ? 'Désactiver' : 'Activer';
                        btn.disabled = false;
                    }
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors du changement de statut');
                }
            }
        }
        
        // Professeurs
        function editProf(username, nom, prenom, specialite) {
            const newNom = prompt('Nouveau nom:', nom);
            if (!newNom) return;
            
            const newPrenom = prompt('Nouveau prénom:', prenom);
            if (!newPrenom) return;
            
            const newSpecialite = prompt('Nouvelle spécialité:', specialite);
            if (!newSpecialite) return;
            
            const newUsername = prompt('Nouveau nom d\'utilisateur (laisser vide pour ne pas changer):', username);
            const newPassword = prompt('Nouveau mot de passe (laisser vide pour ne pas changer):');
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/edit-prof';
            form.innerHTML = `
                <input type="hidden" name="username" value="${username}">
                <input type="hidden" name="nom" value="${newNom}">
                <input type="hidden" name="prenom" value="${newPrenom}">
                <input type="hidden" name="specialite" value="${newSpecialite}">
                <input type="hidden" name="new_username" value="${newUsername || ''}">
                <input type="hidden" name="new_password" value="${newPassword || ''}">
            `;
            document.body.appendChild(form);
            form.submit();
        }
        
        async function deleteProf(username, fullName) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer le professeur "${fullName}" ?\\n\\nTout le contenu publié par ce professeur sera aussi supprimé.\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('username', username);
                
                try {
                    const response = await fetch('/admin/delete-prof', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteProf"]');
                        let profElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${username}'`)) {
                                profElement = btn.closest('.prof-item');
                            }
                        });
                        if (profElement) {
                            profElement.style.transition = 'opacity 0.3s';
                            profElement.style.opacity = '0';
                            setTimeout(() => profElement.remove(), 300);
                        }
                        alert(`✅ Professeur "${fullName}" supprimé avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        // Étudiants
        async function deleteEtudiant(username, fullName) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'étudiant "${fullName}" ?\\n\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('username', username);
                
                try {
                    const response = await fetch('/admin/delete-etudiant', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteEtudiant"]');
                        let etudiantElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${username}'`)) {
                                etudiantElement = btn.closest('.prof-item');
                            }
                        });
                        if (etudiantElement) {
                            etudiantElement.style.transition = 'opacity 0.3s';
                            etudiantElement.style.opacity = '0';
                            setTimeout(() => etudiantElement.remove(), 300);
                        }
                        alert(`✅ Étudiant "${fullName}" supprimé avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        // Universités
        function editUniversite(id, nom, code) {
            const newNom = prompt('Nouveau nom:', nom);
            const newCode = prompt('Nouveau code:', code);
            if (newNom && newCode) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/edit-universite';
                form.innerHTML = `
                    <input type="hidden" name="id" value="${id}">
                    <input type="hidden" name="nom" value="${newNom}">
                    <input type="hidden" name="code" value="${newCode}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        async function deleteUniversite(id, nom) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'université "${nom}" ?\\n\\nTous les UFR, filières, matières et contenus associés seront supprimés.\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('id', id);
                
                try {
                    const response = await fetch('/admin/delete-universite', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteUniversite"]');
                        let uniElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${id}'`)) {
                                uniElement = btn.closest('.academic-item');
                            }
                        });
                        if (uniElement) {
                            uniElement.style.transition = 'opacity 0.3s';
                            uniElement.style.opacity = '0';
                            setTimeout(() => uniElement.remove(), 300);
                        }
                        alert(`✅ Université "${nom}" supprimée avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        // UFR
        function editUfr(id, nom, code) {
            const newNom = prompt('Nouveau nom:', nom);
            const newCode = prompt('Nouveau code:', code);
            if (newNom && newCode) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/edit-ufr';
                form.innerHTML = `
                    <input type="hidden" name="id" value="${id}">
                    <input type="hidden" name="nom" value="${newNom}">
                    <input type="hidden" name="code" value="${newCode}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        async function deleteUfr(id, nom) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'UFR "${nom}" ?\\n\\nToutes les filières, matières et contenus associés seront supprimés.\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('id', id);
                
                try {
                    const response = await fetch('/admin/delete-ufr', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteUfr"]');
                        let ufrElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${id}'`)) {
                                ufrElement = btn.closest('.academic-item');
                            }
                        });
                        if (ufrElement) {
                            ufrElement.style.transition = 'opacity 0.3s';
                            ufrElement.style.opacity = '0';
                            setTimeout(() => ufrElement.remove(), 300);
                        }
                        alert(`✅ UFR "${nom}" supprimée avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        // Filières
        function editFiliere(id, nom, code) {
            const newNom = prompt('Nouveau nom:', nom);
            const newCode = prompt('Nouveau code:', code);
            if (newNom && newCode) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/edit-filiere';
                form.innerHTML = `
                    <input type="hidden" name="id" value="${id}">
                    <input type="hidden" name="nom" value="${newNom}">
                    <input type="hidden" name="code" value="${newCode}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        async function deleteFiliere(id, nom) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer la filière "${nom}" ?\\n\\nToutes les matières et contenus associés seront supprimés.\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('id', id);
                
                try {
                    const response = await fetch('/admin/delete-filiere', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteFiliere"]');
                        let filiereElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${id}'`)) {
                                filiereElement = btn.closest('.academic-item');
                            }
                        });
                        if (filiereElement) {
                            filiereElement.style.transition = 'opacity 0.3s';
                            filiereElement.style.opacity = '0';
                            setTimeout(() => filiereElement.remove(), 300);
                        }
                        alert(`✅ Filière "${nom}" supprimée avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        // Matières
        function editMatiere(id, nom, code) {
            const newNom = prompt('Nouveau nom:', nom);
            const newCode = prompt('Nouveau code:', code);
            if (newNom && newCode) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/admin/edit-matiere';
                form.innerHTML = `
                    <input type="hidden" name="id" value="${id}">
                    <input type="hidden" name="nom" value="${newNom}">
                    <input type="hidden" name="code" value="${newCode}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        async function deleteMatiere(id, nom) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer la matière "${nom}" ?\\n\\nTout le contenu associé sera supprimé.\\nCette action est irréversible.`)) {
                const formData = new FormData();
                formData.append('id', id);
                
                try {
                    const response = await fetch('/admin/delete-matiere', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const buttons = document.querySelectorAll('button[onclick*="deleteMatiere"]');
                        let matiereElement = null;
                        buttons.forEach(btn => {
                            if (btn.onclick && btn.onclick.toString().includes(`'${id}'`)) {
                                matiereElement = btn.closest('.academic-item');
                            }
                        });
                        if (matiereElement) {
                            matiereElement.style.transition = 'opacity 0.3s';
                            matiereElement.style.opacity = '0';
                            setTimeout(() => matiereElement.remove(), 300);
                        }
                        alert(`✅ Matière "${nom}" supprimée avec succès`);
                    } else {
                        alert('❌ Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('❌ Erreur lors de la suppression');
                }
            }
        }
        
        // Fonctions pour gestion des logos
        function uploadLogo(universiteId, universiteNom) {
            document.getElementById('logoUniversiteId').value = universiteId;
            document.getElementById('logoUploadForm').style.display = 'block';
            document.querySelector('#logoUploadForm h3').textContent = `📸 Ajouter un logo à "${universiteNom}"`;
            document.getElementById('logoUploadForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelLogoUpload() {
            document.getElementById('logoUploadForm').style.display = 'none';
            document.getElementById('logoForm').reset();
        }
        
        // Fonction pour basculer l'affichage du mot de passe
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '🙈';
                button.title = 'Masquer le mot de passe';
            } else {
                field.type = 'password';
                button.textContent = '👁️';
                button.title = 'Afficher le mot de passe';
            }
        }
        
        // Fonction universelle pour basculer entre la vue liste et le formulaire de création
        function toggleForm(formType) {
            const listView = document.getElementById(`${formType}-list-view`);
            const formView = document.getElementById(`${formType}-form-view`);
            const arrow = document.getElementById(`arrow-form-${formType}`);
            
            if (!listView || !formView) return;
            
            // Vérifier si le formulaire est actuellement caché (classe hidden ou display none)
            const isFormHidden = formView.classList.contains('hidden') || 
                                 formView.style.display === 'none' || 
                                 window.getComputedStyle(formView).display === 'none';
            
            if (isFormHidden) {
                // Le formulaire est caché, donc on affiche le formulaire et cache la liste
                // Mettre à jour la flèche si elle existe
                if (arrow) arrow.textContent = '▲';
                
                listView.classList.add('fade-out');
                setTimeout(() => {
                    listView.style.display = 'none';
                    listView.classList.remove('fade-out');
                    
                    // Afficher le formulaire
                    formView.style.display = 'block';
                    formView.classList.remove('hidden');
                    formView.classList.add('fade-in');
                    
                    // Scroll vers le formulaire
                    formView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            } else {
                // Le formulaire est visible, donc on cache le formulaire et affiche la liste
                // Mettre à jour la flèche si elle existe
                if (arrow) arrow.textContent = '▼';
                
                formView.classList.remove('fade-in');
                formView.classList.add('fade-out');
                setTimeout(() => {
                    formView.style.display = 'none';
                    formView.classList.remove('fade-out');
                    formView.classList.add('hidden');
                    
                    // Afficher la vue liste
                    listView.style.display = 'block';
                    listView.classList.add('fade-in');
                    
                    // Scroll vers la liste
                    listView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
        }

        
        // Fonction pour soumettre un formulaire en AJAX et recharger la page
        async function submitFormWithReload(event, formElement) {
            event.preventDefault();
            
            const formData = new FormData(formElement);
            const submitButton = formElement.querySelector('button[type="submit"]');
            const originalText = submitButton ? submitButton.textContent : '';
            
            // Désactiver le bouton pendant la soumission
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = '⏳ En cours...';
            }
            
            try {
                const response = await fetch(formElement.action, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Vérifier si c'est une erreur ou un succès depuis l'URL de redirection
                    if (response.redirected) {
                        const url = new URL(response.url);
                        
                        // Vérifier d'abord s'il y a une erreur
                        if (url.searchParams.has('error')) {
                            const errorMsg = url.searchParams.get('error');
                            showAlert(decodeURIComponent(errorMsg), 'error');
                            
                            // Restaurer le bouton pour permettre une nouvelle tentative
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.textContent = originalText;
                            }
                            return; // Ne pas recharger ni réinitialiser le formulaire
                        }
                        
                        // Sinon vérifier s'il y a un message de succès
                        if (url.searchParams.has('success')) {
                            const successMsg = url.searchParams.get('success');
                            showAlert(decodeURIComponent(successMsg), 'success');
                        } else {
                            showAlert('Création réussie !', 'success');
                        }
                    } else {
                        showAlert('Création réussie !', 'success');
                    }
                    
                    // Réinitialiser le formulaire
                    formElement.reset();
                    
                    // Sauvegarder la position de scroll avant de recharger
                    sessionStorage.setItem('scrollPosition', window.scrollY.toString());
                    
                    // Sauvegarder l'onglet actif avant de recharger
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const activeTabId = activeTab.id.replace('tab-', '');
                        sessionStorage.setItem('activeTab', activeTabId);
                    }
                    
                    // Recharger la page après un court délai
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('Une erreur est survenue', 'error');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de connexion', 'error');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            }
        }
        
        // Sauvegarder l'onglet actif avant soumission d'un formulaire
        function saveActiveTabBeforeSubmit() {
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const activeTabId = activeTab.id.replace('tab-', '');
                sessionStorage.setItem('activeTab', activeTabId);
            }
        }
        
        // Intercepter automatiquement tous les formulaires de création
        document.addEventListener('DOMContentLoaded', function() {
            // Restaurer l'onglet actif si il a été sauvegardé
            const savedActiveTab = sessionStorage.getItem('activeTab');
            if (savedActiveTab) {
                showTab(savedActiveTab);
                sessionStorage.removeItem('activeTab');
            }
            
            // Attacher le gestionnaire de sauvegarde à tous les formulaires
            const allForms = document.querySelectorAll('form[action*="/admin/"]');
            allForms.forEach(form => {
                form.addEventListener('submit', saveActiveTabBeforeSubmit);
            });
            
            // Restaurer la position de scroll si elle a été sauvegardée
            const savedScrollPosition = sessionStorage.getItem('scrollPosition');
            if (savedScrollPosition) {
                window.scrollTo(0, parseInt(savedScrollPosition));
                sessionStorage.removeItem('scrollPosition');
            }
            
            // Sélectionner tous les formulaires de création admin
            const createForms = document.querySelectorAll('form[action^="/admin/create-"]');
            
            createForms.forEach(form => {
                form.addEventListener('submit', function(event) {
                    submitFormWithReload(event, this);
                });
            });
        });
        
        // ========== HIÉRARCHIE DE PASSAGE ==========
        
        // Charger les filières pour les selects
        async function loadFilieresForPassage() {
            try {
                const response = await fetch('/api/admin/filieres');
                const data = await response.json();
                
                const selectDepart = document.getElementById('passage-filiere-depart');
                const selectArrivee = document.getElementById('passage-filiere-arrivee');
                
                if (selectDepart && selectArrivee) {
                    selectDepart.innerHTML = '<option value="">Sélectionner une filière</option>';
                    selectArrivee.innerHTML = '<option value="">Sélectionner une filière</option>';
                    
                    data.forEach(filiere => {
                        const optionDepart = new Option(filiere.nom, filiere.id);
                        const optionArrivee = new Option(filiere.nom, filiere.id);
                        selectDepart.add(optionDepart);
                        selectArrivee.add(optionArrivee);
                    });
                }
                
                // Initialiser la gestion de la checkbox "même filière"
                initPassageMemeFiliere();
            } catch (error) {
                console.error('Erreur lors du chargement des filières:', error);
            }
        }
        
        // Helper: Comparaison des niveaux académiques
        function compareNiveaux(niveau1, niveau2) {
            const ordre = {'L1': 1, 'L2': 2, 'L3': 3, 'M1': 4, 'M2': 5};
            return ordre[niveau1] - ordre[niveau2];
        }
        
        // Validation du formulaire de passage (sans soumettre)
        function validatePassageForm(event) {
            const checkbox = document.getElementById('passage-meme-filiere');
            const niveauDepart = document.getElementById('passage-niveau-depart').value;
            const niveauArrivee = document.getElementById('passage-niveau-arrivee').value;
            
            if (checkbox && checkbox.checked) {
                // Validation pour passage dans la même filière
                if (compareNiveaux(niveauArrivee, niveauDepart) <= 0) {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    alert('⚠️ Pour un passage dans la même filière, le niveau d\'arrivée doit être supérieur au niveau de départ.\n\nExemple correct: L1 → L2, L2 → L3, L3 → M1\nExemple incorrect: L2 → L1, L3 → L3');
                    return false;
                }
            }
            // Ne pas retourner true - laisser l'AJAX gérer la soumission
        }
        
        // Gestion de la checkbox "Passage dans la même filière"
        function initPassageMemeFiliere() {
            const checkbox = document.getElementById('passage-meme-filiere');
            const selectDepart = document.getElementById('passage-filiere-depart');
            const selectArrivee = document.getElementById('passage-filiere-arrivee');
            const labelArrivee = document.querySelector('label[for="passage-filiere-arrivee"]');
            const form = document.querySelector('form[action="/admin/create-passage"]');
            
            if (!checkbox || !selectDepart || !selectArrivee) return;
            
            // Ajouter validation au formulaire (en phase de capture)
            if (form) {
                form.addEventListener('submit', validatePassageForm, true);
            }
            
            // Event listener sur la checkbox
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    // Copier la filière de départ vers la filière d'arrivée
                    selectArrivee.value = selectDepart.value;
                    // NE PAS utiliser disabled (empêche l'envoi du formulaire)
                    // Utiliser pointer-events et style pour simuler un champ désactivé
                    selectArrivee.style.opacity = '0.6';
                    selectArrivee.style.pointerEvents = 'none';
                    selectArrivee.style.cursor = 'not-allowed';
                    selectArrivee.setAttribute('data-locked', 'true');
                    if (labelArrivee) labelArrivee.style.opacity = '0.6';
                } else {
                    // Réactiver la sélection manuelle
                    selectArrivee.style.opacity = '1';
                    selectArrivee.style.pointerEvents = 'auto';
                    selectArrivee.style.cursor = 'pointer';
                    selectArrivee.removeAttribute('data-locked');
                    if (labelArrivee) labelArrivee.style.opacity = '1';
                }
            });
            
            // Event listener sur la filière de départ
            selectDepart.addEventListener('change', function() {
                if (checkbox.checked) {
                    // Si "même filière" est coché, synchroniser automatiquement
                    selectArrivee.value = this.value;
                }
            });
        }
        
        // Charger les règles de passage
        async function loadPassageRules() {
            try {
                const response = await fetch('/api/admin/passage-hierarchy');
                const data = await response.json();
                
                const container = document.getElementById('passage-list-container');
                if (!container) return;
                
                if (data.passages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Aucune règle de passage définie</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 1rem;">';
                data.passages.forEach(passage => {
                    // Détection du passage dans la même filière
                    const memeFiliere = passage.filiere_depart === passage.filiere_arrivee;
                    const badgeMemeFiliere = memeFiliere 
                        ? `<span style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 1rem; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);">☑️ MÊME FILIÈRE</span>`
                        : '';
                    
                    html += `
                        <div class="user-card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-left: 4px solid ${memeFiliere ? '#3b82f6' : '#8b5cf6'};">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                    ${memeFiliere 
                                        ? `<strong style="color: #3b82f6;">📚 ${passage.filiere_depart}</strong>
                                           <span style="color: #666;">:</span>
                                           <span style="color: #8b5cf6; font-weight: 600;">${passage.niveau_depart}</span>
                                           <span style="margin: 0 0.5rem; color: #3b82f6; font-weight: bold;">→</span>
                                           <span style="color: #16a34a; font-weight: 600;">${passage.niveau_arrivee}</span>
                                           ${badgeMemeFiliere}`
                                        : `<strong style="color: #8b5cf6;">📚 ${passage.filiere_depart} (${passage.niveau_depart})</strong>
                                           <span style="margin: 0 1rem; color: #666;">→</span>
                                           <strong style="color: #16a34a;">📚 ${passage.filiere_arrivee} (${passage.niveau_arrivee})</strong>`
                                    }
                                </div>
                                ${passage.universite_nom ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">🏛️ ${passage.universite_nom}</div>` : ''}
                            </div>
                            <button onclick="deletePassageRule(${passage.id})" class="btn-small" style="background: #dc2626; color: white;" title="Supprimer">
                                🗑️
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur lors du chargement des règles:', error);
                document.getElementById('passage-list-container').innerHTML = '<p style="text-align: center; color: #dc2626; padding: 1rem;">Erreur de chargement</p>';
            }
        }
        
        // Charger les statistiques
        async function loadPassageStats() {
            try {
                const response = await fetch('/api/admin/passage/statistiques');
                const data = await response.json();
                
                const container = document.getElementById('passage-stats-container');
                if (!container) return;
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 0.75rem 1rem;">
                            <h3 style="color: white; font-size: 0.9rem; margin-bottom: 0.25rem;">Total passages</h3>
                            <div style="font-size: 1.5rem; font-weight: bold; color: white;">${data.total}</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 0.75rem 1rem;">
                            <h3 style="color: white; font-size: 0.9rem; margin-bottom: 0.25rem;">Passés</h3>
                            <div style="font-size: 1.5rem; font-weight: bold; color: white;">${data.passes}</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); padding: 0.75rem 1rem;">
                            <h3 style="color: white; font-size: 0.9rem; margin-bottom: 0.25rem;">Redoublants</h3>
                            <div style="font-size: 1.5rem; font-weight: bold; color: white;">${data.redoublants}</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); padding: 0.75rem 1rem;">
                            <h3 style="color: white; font-size: 0.9rem; margin-bottom: 0.25rem;">Changements filière</h3>
                            <div style="font-size: 1.5rem; font-weight: bold; color: white;">${data.changements_filiere}</div>
                        </div>
                    </div>
                `;
                
                if (data.recent_passages && data.recent_passages.length > 0) {
                    html += '<h4 style="margin-bottom: 1rem;">Passages récents</h4>';
                    html += '<div style="display: grid; gap: 0.5rem;">';
                    data.recent_passages.forEach(p => {
                        const badgeColor = p.statut === 'passé' ? '#16a34a' : '#ea580c';
                        html += `
                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>${p.nom}</strong>: ${p.ancien_niveau} → ${p.nouveau_niveau}</span>
                                <span style="background: ${badgeColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                                    ${p.statut}
                                </span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                document.getElementById('passage-stats-container').innerHTML = '<p style="text-align: center; color: #dc2626; padding: 1rem;">Erreur de chargement</p>';
            }
        }
        
        // Supprimer une règle de passage
        async function deletePassageRule(passageId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette règle de passage ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/passage/${passageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Règle supprimée avec succès', 'success');
                    loadPassageRules();
                } else {
                    showAlert('Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de communication avec le serveur', 'error');
            }
        }
        
        // Initialiser l'onglet passage quand il est ouvert
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            
            if (tabName === 'passage') {
                loadFilieresForPassage();
                loadPassageRules();
                loadPassageStats();
            }
        };
        
        // Fonction réutilisable pour gérer les soumissions AJAX des formulaires admin
        function setupAdminFormAjax(formSelector, onSuccess) {
            const form = document.querySelector(formSelector);
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                
                if (submitBtn) {
                    submitBtn.disabled = true;
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = '⏳ En cours...';
                    
                    try {
                        const response = await fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showAlert(data.message, 'success');
                            
                            // Sauvegarder l'onglet actif avant de recharger
                            const activeTab = document.querySelector('.tab-btn.active');
                            if (activeTab) {
                                const tabName = activeTab.id.replace('tab-', '');
                                sessionStorage.setItem('activeAdminTab', tabName);
                            }
                            
                            // Recharger immédiatement pour afficher la nouvelle entité
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                            
                            if (onSuccess && typeof onSuccess === 'function') {
                                onSuccess(data);
                            }
                        } else {
                            showAlert(data.message, 'error');
                        }
                    } catch (error) {
                        console.error('Erreur AJAX:', error);
                        showAlert('Erreur de communication avec le serveur', 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }
            });
        }
        
        // Appliquer AJAX aux formulaires admin
        document.addEventListener('DOMContentLoaded', function() {
            // Restaurer l'onglet actif après rechargement
            const savedTab = sessionStorage.getItem('activeAdminTab');
            if (savedTab) {
                showTab(savedTab);
                sessionStorage.removeItem('activeAdminTab');
            }
            
            setupAdminFormAjax('form[action="/admin/create-admin"]');
            setupAdminFormAjax('form[action="/admin/create-prof"]');
            setupAdminFormAjax('form[action="/admin/create-universite"]');
            setupAdminFormAjax('form[action="/admin/create-ufr"]');
            setupAdminFormAjax('form[action="/admin/create-filiere"]');
            setupAdminFormAjax('form[action="/admin/create-matiere"]');
            setupAdminFormAjax('form[action="/admin/create-passage"]', function() {
                loadPassageRules();
                loadPassageStats();
            });
        });
        
        // Exposer toutes les fonctions au scope global pour les attributs onclick
        // Ceci résout le problème où les fonctions ne sont pas accessibles sur Render
        window.showTab = showTab;
        window.loadUniversiteSettings = loadUniversiteSettings;
        window.toggleTelechargements = toggleTelechargements;
        window.updateDownloadButtonStatus = updateDownloadButtonStatus;
        window.loadDownloadStatus = loadDownloadStatus;
        window.togglePassageClasse = togglePassageClasse;
        window.updatePassageClasseButtonStatus = updatePassageClasseButtonStatus;
        window.loadPassageClasseStatus = loadPassageClasseStatus;
        window.filterCheckboxes = filterCheckboxes;
        window.updateFiliereCheckboxes = updateFiliereCheckboxes;
        window.searchUfr = searchUfr;
        window.searchFiliere = searchFiliere;
        window.searchMatiere = searchMatiere;
        window.toggleNiveauMatieres = toggleNiveauMatieres;
        window.toggleSemestreMatieres = toggleSemestreMatieres;
        window.searchAdmin = searchAdmin;
        window.searchProf = searchProf;
        window.searchEtudiant = searchEtudiant;
        window.searchUniversite = searchUniversite;
        window.filterSelectOptions = filterSelectOptions;
        window.editAdmin = editAdmin;
        window.toggleAdminStatus = toggleAdminStatus;
        window.deleteAdmin = deleteAdmin;
        window.toggleProfStatus = toggleProfStatus;
        window.editProf = editProf;
        window.deleteProf = deleteProf;
        window.deleteEtudiant = deleteEtudiant;
        window.editUniversite = editUniversite;
        window.deleteUniversite = deleteUniversite;
        window.editUfr = editUfr;
        window.deleteUfr = deleteUfr;
        window.editFiliere = editFiliere;
        window.deleteFiliere = deleteFiliere;
        window.editMatiere = editMatiere;
        window.deleteMatiere = deleteMatiere;
        window.uploadLogo = uploadLogo;
        window.cancelLogoUpload = cancelLogoUpload;
        window.togglePassword = togglePassword;
        window.toggleForm = toggleForm;
        window.submitFormWithReload = submitFormWithReload;
        window.saveActiveTabBeforeSubmit = saveActiveTabBeforeSubmit;
        window.loadFilieresForPassage = loadFilieresForPassage;
        window.compareNiveaux = compareNiveaux;
        window.validatePassageForm = validatePassageForm;
        window.initPassageMemeFiliere = initPassageMemeFiliere;
        window.loadPassageRules = loadPassageRules;
        window.loadPassageStats = loadPassageStats;
        window.deletePassageRule = deletePassageRule;
        window.setupAdminFormAjax = setupAdminFormAjax;
    </script>
    
    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef; color: #666; font-size: 0.9rem;">
        © 2025 Maodo Ka - Tous droits réservés | Étude LINE
    </div>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker enregistré avec succès:', registration.scope);
                        
                        // Forcer mise à jour lors de la détection d'un nouveau SW
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('🔄 Nouveau Service Worker activé, rechargement...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('❌ Échec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }
    </script>
</body>
