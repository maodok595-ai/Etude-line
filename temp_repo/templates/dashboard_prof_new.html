<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord Professeur - √âtude LINE</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="√âtude LINE">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    
    <style>
        /* D√©sactiver s√©lection accidentelle sur l'interface */
        button, .navbar, .navbar *, a, .btn, 
        .welcome-card, .prof-info-box, h1, h2, h3,
        .stats-card, .user-info, .logout-btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* Garder la s√©lection pour le contenu */
        textarea, input, .form-control, p {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f6fa 0%, #e8eaf6 100%);
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar h1 { font-size: 1.5rem; }
        .navbar .user-info { display: flex; align-items: center; gap: 1rem; }
        .navbar a { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 5px; transition: background 0.3s; }
        .navbar a:hover { background: rgba(255,255,255,0.2); }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            position: relative;
            overflow: hidden;
        }
        
        .welcome-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .welcome-card h2 {
            font-family: 'Poppins', sans-serif;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 1.3rem;
        }
        
        .prof-info-box {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(102, 126, 234, 0.08);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .prof-info-box p {
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
        }
        
        .prof-info-box p:last-child {
            margin-bottom: 0;
        }
        
        .add-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .add-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
        
        .niveau-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .niveau-header {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }
        
        .matiere-item {
            margin-bottom: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .matiere-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .matiere-header:hover { background: linear-gradient(135deg, #5568d3, #653a8b); }
        .matiere-header h3 { font-size: 1.2rem; font-weight: 500; }
        
        .toggle-arrow {
            font-size: 1.3rem;
            transition: transform 0.3s ease;
            display: inline-block;
        }
        
        .toggle-arrow.open { transform: rotate(90deg); }
        
        .matiere-content {
            display: none;
            padding: 1.5rem;
            background: #f8f9fa;
        }
        
        .matiere-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .semestre-section { margin-bottom: 1.5rem; }
        
        .semestre-title {
            font-size: 1.1rem;
            color: #764ba2;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
            border-left: 4px solid #764ba2;
        }
        
        .chapitre-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        
        .chapitre-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            transition: background 0.3s ease;
        }
        
        .chapitre-header:hover { background: #f5f5f5; }
        .chapitre-title { font-weight: 500; color: #333; flex: 1; }
        
        .chapitre-actions {
            display: flex;
            gap: 0.5rem;
            margin-right: 1rem;
        }
        
        .btn-edit, .btn-delete {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-edit {
            background: #ff9800;
            color: white;
        }
        
        .btn-edit:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .btn-delete:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        .chapitre-content {
            display: none;
            padding: 1.5rem;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
        }
        
        .chapitre-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        .content-section { margin-bottom: 1.5rem; }
        .content-section h4 { color: #667eea; margin-bottom: 0.75rem; font-size: 1.1rem; }
        
        .content-text {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .file-link {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .file-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .navbar { padding: 1rem; flex-direction: column; gap: 1rem; text-align: center; }
            .navbar h1 { font-size: 1.3rem; }
            .container { margin: 1rem auto; padding: 0 1rem; }
            .welcome-card { padding: 1.5rem !important; margin-bottom: 1.5rem !important; }
            .welcome-card h2 { font-size: 1.1rem !important; }
            .niveau-header { font-size: 1.2rem; }
            .matiere-header h3 { font-size: 1rem; }
            .chapitre-header { padding: 0.75rem 1rem; flex-wrap: wrap; }
            .chapitre-actions { margin-right: 0; margin-top: 0.5rem; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üë®‚Äçüè´ √âtude LINE - Espace Professeur</h1>
        <div class="user-info">
            <span>{{ prof.prenom }} {{ prof.nom }}</span>
            <a href="/logout">D√©connexion</a>
        </div>
    </div>
    
    <div class="container">
        <!-- Messages d'alerte -->
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                document.write('<div class="alert alert-success">‚úÖ ' + urlParams.get('success') + '</div>');
            }
            if (urlParams.has('error')) {
                document.write('<div class="alert alert-error">‚ö†Ô∏è ' + urlParams.get('error') + '</div>');
            }
        </script>
        
        <div class="welcome-card">
            <h2>Bienvenue, {{ prof.prenom }} {{ prof.nom }} ! üëã</h2>
            <div class="prof-info-box">
                <p><strong>üë®‚Äçüè´ Sp√©cialit√© :</strong> {{ prof.specialite }}</p>
                {% if prof.universite %}
                <p><strong>üèõÔ∏è Universit√© :</strong> {{ prof.universite }}</p>
                {% endif %}
                {% if prof.ufr %}
                <p><strong>üè¢ UFR :</strong> {{ prof.ufr }}</p>
                {% endif %}
                {% if prof.filiere %}
                <p><strong>üìñ Fili√®re :</strong> {{ prof.filiere }}</p>
                {% endif %}
                {% if prof.matiere_nom %}
                <p><strong>üìö Mati√®re :</strong> {{ prof.matiere_nom }}</p>
                {% endif %}
            </div>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="/dashboard/prof" class="add-button">‚ûï Interface de gestion (cr√©er/modifier)</a>
            </div>
            <p style="margin-top: 1rem; color: #666;">Visualisez vos contenus organis√©s ci-dessous. Utilisez l'interface de gestion pour cr√©er ou modifier.</p>
        </div>
        
        <div id="loading" class="loading">
            <p>‚è≥ Chargement de vos contenus...</p>
        </div>
        
        <div id="content-hierarchy" style="display: none;">
            <!-- Hierarchical content will be loaded here -->
        </div>
        
        <div id="empty-state" class="empty-state" style="display: none;">
            <h3>üì≠ Aucun contenu disponible</h3>
            <p>Vous n'avez pas encore publi√© de contenu. Cliquez sur "Interface de gestion" pour commencer.</p>
        </div>
    </div>
    
    <script>
        // Load hierarchical content
        async function loadContent() {
            try {
                const response = await fetch('/api/chapitres/hierarchy');
                const data = await response.json();
                
                const loadingEl = document.getElementById('loading');
                const contentEl = document.getElementById('content-hierarchy');
                const emptyEl = document.getElementById('empty-state');
                
                loadingEl.style.display = 'none';
                
                if (!data.hierarchy || data.hierarchy.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }
                
                contentEl.style.display = 'block';
                contentEl.innerHTML = renderHierarchy(data.hierarchy);
            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('loading').innerHTML = '<p style="color: red;">‚ùå Erreur lors du chargement</p>';
            }
        }
        
        function getNiveauComplet(code) {
            const niveaux = {
                'L1': 'Licence 1',
                'L2': 'Licence 2',
                'L3': 'Licence 3',
                'M1': 'Master 1',
                'M2': 'Master 2'
            };
            return niveaux[code] || code;
        }
        
        function renderHierarchy(hierarchy) {
            return hierarchy.map(niveau => `
                <div class="niveau-card">
                    <div class="niveau-header">${getNiveauComplet(niveau.niveau)}</div>
                    ${niveau.matieres.map(matiere => `
                        <div class="matiere-item">
                            <div class="matiere-header" onclick="toggleMatiere(this)">
                                <h3>${matiere.matiere_nom}</h3>
                                <span class="toggle-arrow">‚ñ∏</span>
                            </div>
                            <div class="matiere-content">
                                ${matiere.semestres.map(semestre => `
                                    <div class="semestre-section">
                                        <div class="semestre-title">${semestre.semestre}</div>
                                        ${semestre.chapitres.map(chapitre => `
                                            <div class="chapitre-item">
                                                <div class="chapitre-header" onclick="toggleChapitre(event, this)">
                                                    <span class="chapitre-title">Chapitre ${chapitre.numero} : ${chapitre.titre}</span>
                                                    <div class="chapitre-actions">
                                                        <button class="btn-edit" onclick="event.stopPropagation(); window.location.href='/dashboard/prof#edit-${chapitre.id}'" title="Modifier">‚úèÔ∏è</button>
                                                        <button class="btn-delete" onclick="event.stopPropagation(); deleteChapter('${chapitre.id}', '${escapeHtml(chapitre.titre)}')" title="Supprimer">üóëÔ∏è</button>
                                                    </div>
                                                    <span class="toggle-arrow">‚ñ∏</span>
                                                </div>
                                                <div class="chapitre-content">
                                                    ${renderChapitreContent(chapitre)}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        function renderChapitreContent(chapitre) {
            let html = '';
            
            if (chapitre.cours_texte || chapitre.cours_fichier_nom) {
                html += '<div class="content-section"><h4>üìñ Cours</h4>';
                if (chapitre.cours_texte) html += `<div class="content-text">${escapeHtml(chapitre.cours_texte)}</div>`;
                if (chapitre.cours_fichier_nom) {
                    const files = chapitre.cours_fichier_nom.split('|||');
                    const paths = chapitre.cours_fichier_path.split('|||');
                    files.forEach((file, idx) => {
                        html += `<a href="/${paths[idx]}" class="file-link" download>üìé ${file}</a>`;
                    });
                }
                html += '</div>';
            }
            
            if (chapitre.exercice_texte || chapitre.exercice_fichier_nom) {
                html += '<div class="content-section"><h4>‚úçÔ∏è Exercices</h4>';
                if (chapitre.exercice_texte) html += `<div class="content-text">${escapeHtml(chapitre.exercice_texte)}</div>`;
                if (chapitre.exercice_fichier_nom) {
                    const files = chapitre.exercice_fichier_nom.split('|||');
                    const paths = chapitre.exercice_fichier_path.split('|||');
                    files.forEach((file, idx) => {
                        html += `<a href="/${paths[idx]}" class="file-link" download>üìé ${file}</a>`;
                    });
                }
                html += '</div>';
            }
            
            if (chapitre.solution_texte || chapitre.solution_fichier_nom) {
                html += '<div class="content-section"><h4>‚úÖ Solutions</h4>';
                if (chapitre.solution_texte) html += `<div class="content-text">${escapeHtml(chapitre.solution_texte)}</div>`;
                if (chapitre.solution_fichier_nom) {
                    const files = chapitre.solution_fichier_nom.split('|||');
                    const paths = chapitre.solution_fichier_path.split('|||');
                    files.forEach((file, idx) => {
                        html += `<a href="/${paths[idx]}" class="file-link" download>üìé ${file}</a>`;
                    });
                }
                html += '</div>';
            }
            
            return html;
        }
        
        function toggleMatiere(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.toggle-arrow');
            content.classList.toggle('show');
            arrow.classList.toggle('open');
        }
        
        function toggleChapitre(event, header) {
            if (event.target.closest('.chapitre-actions')) return;
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.toggle-arrow');
            content.classList.toggle('show');
            arrow.classList.toggle('open');
        }
        
        function deleteChapter(id, title) {
            if (confirm(`Supprimer le chapitre "${title}" ?\\n\\nCette action est irr√©versible.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/prof/delete-chapitre';
                form.innerHTML = `<input type="hidden" name="chapitre_id" value="${id}">`;
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        loadContent();
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker enregistr√© avec succ√®s:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå √âchec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
