"""
Migration pour ajouter les relations many-to-many pour les professeurs
- Cr√©e les tables professeur_ufrs et professeur_filieres
- Migre les donn√©es existantes
"""

from sqlalchemy import text
from database import engine, get_db
from models import Base, Professeur
import traceback

def migrate_professeur_multi():
    """Ajoute les tables de liaison et migre les donn√©es existantes"""
    
    print("\n" + "="*70)
    print("üîÑ MIGRATION : Relations multiples UFR/Fili√®res pour professeurs")
    print("="*70)
    
    try:
        with engine.connect() as conn:
            # √âtape 1: Cr√©er les tables de liaison
            print("\nüìä √âtape 1 : Cr√©ation des tables de liaison...")
            
            # V√©rifier si la table professeur_ufrs existe d√©j√†
            result = conn.execute(text("""
                SELECT table_name 
                FROM information_schema.tables 
                WHERE table_name = 'professeur_ufrs'
            """))
            
            if result.fetchone() is None:
                # Cr√©er la table professeur_ufrs
                conn.execute(text("""
                    CREATE TABLE IF NOT EXISTS professeur_ufrs (
                        professeur_id INTEGER NOT NULL,
                        ufr_id VARCHAR NOT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        PRIMARY KEY (professeur_id, ufr_id),
                        FOREIGN KEY (professeur_id) REFERENCES professeurs(id) ON DELETE CASCADE,
                        FOREIGN KEY (ufr_id) REFERENCES ufrs(id) ON DELETE CASCADE
                    )
                """))
                conn.commit()
                print("‚úÖ Table professeur_ufrs cr√©√©e")
            else:
                print("‚ÑπÔ∏è  Table professeur_ufrs existe d√©j√†")
            
            # V√©rifier si la table professeur_filieres existe d√©j√†
            result = conn.execute(text("""
                SELECT table_name 
                FROM information_schema.tables 
                WHERE table_name = 'professeur_filieres'
            """))
            
            if result.fetchone() is None:
                # Cr√©er la table professeur_filieres
                conn.execute(text("""
                    CREATE TABLE IF NOT EXISTS professeur_filieres (
                        professeur_id INTEGER NOT NULL,
                        filiere_id VARCHAR NOT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        PRIMARY KEY (professeur_id, filiere_id),
                        FOREIGN KEY (professeur_id) REFERENCES professeurs(id) ON DELETE CASCADE,
                        FOREIGN KEY (filiere_id) REFERENCES filieres(id) ON DELETE CASCADE
                    )
                """))
                conn.commit()
                print("‚úÖ Table professeur_filieres cr√©√©e")
            else:
                print("‚ÑπÔ∏è  Table professeur_filieres existe d√©j√†")
            
            # √âtape 2: Migrer les donn√©es existantes
            print("\nüì¶ √âtape 2 : Migration des donn√©es existantes...")
            
            # R√©cup√©rer tous les professeurs avec UFR et fili√®re
            result = conn.execute(text("""
                SELECT id, ufr_id, filiere_id
                FROM professeurs
                WHERE ufr_id IS NOT NULL OR filiere_id IS NOT NULL
            """))
            
            professeurs = result.fetchall()
            migrated_count = 0
            
            for prof in professeurs:
                prof_id = prof[0]
                ufr_id = prof[1]
                filiere_id = prof[2]
                
                # Migrer UFR si existe
                if ufr_id:
                    # V√©rifier si la relation n'existe pas d√©j√†
                    check = conn.execute(text("""
                        SELECT 1 FROM professeur_ufrs
                        WHERE professeur_id = :prof_id AND ufr_id = :ufr_id
                    """), {"prof_id": prof_id, "ufr_id": ufr_id})
                    
                    if check.fetchone() is None:
                        conn.execute(text("""
                            INSERT INTO professeur_ufrs (professeur_id, ufr_id)
                            VALUES (:prof_id, :ufr_id)
                        """), {"prof_id": prof_id, "ufr_id": ufr_id})
                
                # Migrer Fili√®re si existe
                if filiere_id:
                    # V√©rifier si la relation n'existe pas d√©j√†
                    check = conn.execute(text("""
                        SELECT 1 FROM professeur_filieres
                        WHERE professeur_id = :prof_id AND filiere_id = :filiere_id
                    """), {"prof_id": prof_id, "filiere_id": filiere_id})
                    
                    if check.fetchone() is None:
                        conn.execute(text("""
                            INSERT INTO professeur_filieres (professeur_id, filiere_id)
                            VALUES (:prof_id, :filiere_id)
                        """), {"prof_id": prof_id, "filiere_id": filiere_id})
                
                migrated_count += 1
            
            conn.commit()
            print(f"‚úÖ {migrated_count} professeur(s) migr√©(s) vers le nouveau syst√®me")
            
            # √âtape 3: V√©rification
            print("\nüîç √âtape 3 : V√©rification...")
            
            result = conn.execute(text("SELECT COUNT(*) FROM professeur_ufrs"))
            ufr_count = result.fetchone()[0]
            print(f"   üìä Relations Professeur-UFR : {ufr_count}")
            
            result = conn.execute(text("SELECT COUNT(*) FROM professeur_filieres"))
            filiere_count = result.fetchone()[0]
            print(f"   üìä Relations Professeur-Fili√®re : {filiere_count}")
            
            print("\n" + "="*70)
            print("‚úÖ MIGRATION TERMIN√âE AVEC SUCC√àS")
            print("="*70)
            print("\n‚ÑπÔ∏è  Les anciennes colonnes (ufr_id, filiere_id, matiere_id)")
            print("   sont conserv√©es pour la r√©trocompatibilit√©.")
            print("   Elles peuvent √™tre supprim√©es une fois que tout fonctionne.")
            print("="*70 + "\n")
            
            return True
            
    except Exception as e:
        print(f"\n‚ùå ERREUR lors de la migration : {e}")
        traceback.print_exc()
        return False

if __name__ == "__main__":
    migrate_professeur_multi()
