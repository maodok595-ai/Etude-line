"""
Migration pour ajouter le stockage des logos d'universit√© dans PostgreSQL
Ajoute les colonnes logo_data (LargeBinary) et logo_content_type √† la table universites
"""

import os
from sqlalchemy import create_engine, text

# Utiliser EXTERNAL_DATABASE_URL pour Render
DATABASE_URL = os.getenv("EXTERNAL_DATABASE_URL") or os.getenv("DATABASE_URL")

if not DATABASE_URL:
    print("‚ùå Erreur: DATABASE_URL non trouv√©")
    exit(1)

print(f"üîó Connexion √† la base de donn√©es...")
engine = create_engine(DATABASE_URL)

print("\n" + "="*70)
print("üîÑ MIGRATION: STOCKAGE DES LOGOS DANS POSTGRESQL")
print("="*70)
print("\n‚ö†Ô∏è  Cette migration ajoute deux colonnes √† la table universites:")
print("   - logo_data (BYTEA) : Pour stocker l'image directement en base")
print("   - logo_content_type (VARCHAR) : Pour stocker le type MIME de l'image\n")

with engine.connect() as conn:
    trans = None
    try:
        # Commencer une transaction
        trans = conn.begin()
        
        print("[1/2] Ajout de la colonne logo_data...")
        conn.execute(text("""
            ALTER TABLE universites 
            ADD COLUMN IF NOT EXISTS logo_data BYTEA
        """))
        print("    ‚úÖ Colonne logo_data ajout√©e")
        
        print("[2/2] Ajout de la colonne logo_content_type...")
        conn.execute(text("""
            ALTER TABLE universites 
            ADD COLUMN IF NOT EXISTS logo_content_type VARCHAR(50)
        """))
        print("    ‚úÖ Colonne logo_content_type ajout√©e")
        
        # Valider la transaction
        trans.commit()
        
        print("\n" + "="*70)
        print("‚úÖ MIGRATION TERMIN√âE AVEC SUCC√àS")
        print("="*70)
        print("\nüìù R√©sum√© des modifications:")
        print("   - universites.logo_data ‚Üí BYTEA (pour stocker les images)")
        print("   - universites.logo_content_type ‚Üí VARCHAR(50) (pour le type MIME)")
        print("\nüí° Avantages du stockage en base de donn√©es:")
        print("   ‚úÖ Persistance garantie entre les red√©ploiements Render")
        print("   ‚úÖ Pas besoin de Render Disk")
        print("   ‚úÖ Sauvegarde automatique avec la base de donn√©es")
        print("   ‚úÖ Rollback possible avec les checkpoints Replit")
        print("\n")
        
    except Exception as e:
        if trans:
            trans.rollback()
        print(f"\n‚ùå Erreur lors de la migration: {e}")
        print("   Transaction annul√©e - aucune modification n'a √©t√© appliqu√©e")
        raise
    finally:
        conn.close()

print("üîí Connexion ferm√©e")
